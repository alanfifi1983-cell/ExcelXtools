<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyHub Pro - 雲端序號銷售系統 (正式部署版)</title>
    <!-- 核心函式庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (Compat 模式) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 1. Firebase 配置金鑰
        // ==========================================
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC3ryVnW-6ZIG9ZuK56I9kNabcKOi89FUQ",
            authDomain: "bobo-f4afd.firebaseapp.com",
            projectId: "bobo-f4afd", 
            storageBucket: "bobo-f4afd.firebasestorage.app",
            messagingSenderId: "96116350820",
            appId: "1:96116350820:web:e6a8525c0283783209e471"
        };

        const App = () => {
            const [view, setView] = useState('login'); 
            const [appUser, setAppUser] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState('keyhub-pro-v1'); 
            const [errorMsg, setErrorMsg] = useState(null); // 新增錯誤訊息狀態
            
            const [products, setProducts] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [systemUsers, setSystemUsers] = useState([]);
            
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [editingProduct, setEditingProduct] = useState(null);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            
            const [cartItem, setCartItem] = useState(null);
            const [emailInput, setEmailInput] = useState("");
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [imagePreview, setImagePreview] = useState("");
            const fileInputRef = useRef(null);

            // 初始化 Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        if (!MY_FIREBASE_CONFIG.apiKey || MY_FIREBASE_CONFIG.apiKey.includes("你的API")) {
                            setErrorMsg("尚未設定 Firebase API Key。");
                            setLoading(false);
                            return;
                        }

                        if (!firebase.apps.length) firebase.initializeApp(MY_FIREBASE_CONFIG);
                        const auth = firebase.auth();
                        const firestore = firebase.firestore();

                        // 匿名登入 (這是多人共用的關鍵)
                        await auth.signInAnonymously();

                        setDb(firestore);
                        setupDataSync(firestore, appId);

                    } catch (err) {
                        console.error("Firebase 連線失敗:", err);
                        // 針對網域未授權的常見錯誤提供提示
                        if (err.code === 'auth/unauthorized-domain') {
                            setErrorMsg("此網域尚未在 Firebase 授權。請將 github.io 加入 Firebase 的授權網域清單。");
                        } else {
                            setErrorMsg("系統連線失敗: " + err.message);
                        }
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            const setupDataSync = (dbInstance, id) => {
                const dataRef = dbInstance.collection('artifacts').doc(id).collection('public').doc('data');

                // 錯誤處理：監聽失敗時顯示
                const handleError = (err) => {
                    console.error("Firestore Error:", err);
                    if (err.message.includes("permission-denied")) {
                        setErrorMsg("資料庫權限不足，請檢查 Firebase Firestore 的 Rules 設定。");
                    }
                };

                dataRef.collection('products').onSnapshot(snap => {
                    setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, handleError);

                dataRef.collection('keys').onSnapshot(snap => {
                    setInventory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, handleError);

                dataRef.collection('users').onSnapshot(async (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (list.length === 0 || !list.some(u => u.username === 'admin')) {
                        try {
                            await dataRef.collection('users').add({
                                username: 'admin',
                                password: '123',
                                role: 'admin'
                            });
                        } catch(e) { console.log("Admin 初始化跳過或失敗"); }
                    }
                    setSystemUsers(list);
                    setLoading(false);
                }, handleError);
            };

            const stockOverview = useMemo(() => {
                const summary = {};
                inventory.forEach(item => {
                    const name = item.productName || "未知產品";
                    if (!summary[name]) summary[name] = { total: 0, available: 0 };
                    summary[name].total++;
                    if (item.status === 'available') summary[name].available++;
                });
                return summary;
            }, [inventory]);

            const getStockCount = (name) => stockOverview[name]?.available || 0;

            const handleLogin = (e) => {
                e.preventDefault();
                const user = systemUsers.find(u => 
                    String(u.username).trim() === loginForm.username.trim() && 
                    String(u.password).trim() === loginForm.password.trim()
                );
                if (user) {
                    setAppUser(user);
                    setView('shop');
                } else {
                    alert("登入失敗：請檢查帳號密碼");
                }
            };

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const pData = {
                    name: formData.get('name').trim(),
                    price: Number(formData.get('price')),
                    image: imagePreview || formData.get('image') || 'https://via.placeholder.com/300',
                    description: formData.get('description'),
                    isActive: formData.get('isActive') === 'on',
                    updatedAt: new Date().toISOString()
                };

                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('products');
                if (editingProduct) {
                    await col.doc(editingProduct.id).update(pData);
                } else {
                    await col.add({ ...pData, createdAt: new Date().toISOString() });
                }
                setIsProductModalOpen(false);
                setEditingProduct(null);
                setImagePreview("");
            };

            const handlePurchase = async () => {
                const keyDoc = inventory.find(k => k.productName === cartItem.name && k.status === 'available');
                if (!keyDoc) return alert("庫存已售完");

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('keys').doc(keyDoc.id).update({
                    status: 'sold',
                    customerEmail: emailInput,
                    soldTime: new Date().toISOString(),
                    soldBy: appUser.username
                });

                alert(`購買成功！序號為：${keyDoc.key}`);
                setCartItem(null);
                setEmailInput("");
            };

            // 錯誤訊息顯示
            if (errorMsg) {
                return (
                    <div className="h-screen flex items-center justify-center bg-slate-100 p-6 text-center">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-lg border border-red-100">
                            <i className="fa-solid fa-triangle-exclamation text-red-500 text-5xl mb-4"></i>
                            <h2 className="text-xl font-bold mb-4 text-slate-800">系統啟動中斷</h2>
                            <div className="bg-red-50 p-4 rounded-xl text-red-700 text-sm font-mono text-left mb-6 break-words">
                                {errorMsg}
                            </div>
                            <button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold">重新整理</button>
                        </div>
                    </div>
                );
            }

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white">
                    <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="font-bold tracking-widest opacity-60">雲端資料載入中...</p>
                </div>
            );

            if (view === 'login') return (
                <div className="h-screen bg-slate-50 flex items-center justify-center p-6 text-center text-slate-800">
                    <div className="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-xl border border-slate-100 animate-fade-in">
                        <div className="bg-indigo-600 w-16 h-16 rounded-2xl text-white flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-100 italic font-black text-2xl">KH</div>
                        <h1 className="text-3xl font-black mb-1 italic">KEYHUB <span className="text-indigo-600">PRO</span></h1>
                        <p className="text-slate-400 font-bold text-xs mb-8 uppercase tracking-widest">雲端銷售管理系統</p>
                        <form onSubmit={handleLogin} className="space-y-4 text-left">
                            <input type="text" placeholder="管理帳號" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold transition-all text-slate-700" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} />
                            <input type="password" placeholder="密碼" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold transition-all text-slate-700" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} />
                            <button className="w-full py-5 bg-indigo-600 text-white font-black text-lg rounded-2xl hover:bg-indigo-700 shadow-xl transition-all active:scale-95">登入系統</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col text-slate-800">
                    {/* 導航 */}
                    <nav className="bg-white border-b h-16 flex items-center px-6 justify-between sticky top-0 z-40">
                        <div className="flex items-center gap-2 font-black text-xl cursor-pointer" onClick={() => setView('shop')}>
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white"><i className="fa-solid fa-key"></i></div>
                            <span>KeyHub</span>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-xl gap-1">
                            <button onClick={() => setView('shop')} className={`px-4 py-1.5 rounded-lg font-bold text-xs ${view === 'shop' || view === 'detail' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>商店</button>
                            {appUser.role === 'admin' && (
                                <>
                                    <button onClick={() => setView('admin_products')} className={`px-4 py-1.5 rounded-lg font-bold text-xs ${view === 'admin_products' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>商品管理</button>
                                    <button onClick={() => setView('admin_keys')} className={`px-4 py-1.5 rounded-lg font-bold text-xs ${view === 'admin_keys' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>序號庫存</button>
                                </>
                            )}
                        </div>
                        <button onClick={() => { setAppUser(null); setView('login'); }} className="p-2 text-slate-400 hover:text-red-500"><i className="fa-solid fa-right-from-bracket"></i></button>
                    </nav>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-6 animate-fade-in">
                        {view === 'shop' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                {products.length === 0 ? (
                                    <div className="col-span-full py-20 text-center opacity-30 italic font-bold">目前尚無上架商品，請至後台新增。</div>
                                ) : (
                                    products.filter(p => p.isActive).map(p => (
                                        <div key={p.id} onClick={() => { setSelectedProduct(p); setView('detail'); }} className="bg-white p-3 rounded-3xl border border-slate-100 shadow-sm hover:shadow-lg transition-all cursor-pointer group">
                                            <div className="aspect-square rounded-2xl overflow-hidden bg-slate-100 mb-4">
                                                <img src={p.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                                            </div>
                                            <div className="px-2 pb-2">
                                                <h3 className="font-bold text-slate-800 truncate">{p.name}</h3>
                                                <div className="flex justify-between items-center mt-2">
                                                    <span className="text-indigo-600 font-black">NT$ {p.price}</span>
                                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${getStockCount(p.name) > 0 ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>在庫: {getStockCount(p.name)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'detail' && selectedProduct && (
                            <div className="max-w-5xl mx-auto bg-white rounded-[2.5rem] p-8 md:p-12 shadow-xl flex flex-col md:flex-row gap-12 items-center">
                                <div className="w-full md:w-1/2 aspect-square rounded-[2rem] overflow-hidden shadow-2xl border-4 border-slate-50">
                                    <img src={selectedProduct.image} className="w-full h-full object-cover" />
                                </div>
                                <div className="flex-1">
                                    <h2 className="text-5xl font-black text-slate-800 mb-4 leading-tight">{selectedProduct.name}</h2>
                                    <p className="text-slate-500 text-lg mb-8 leading-relaxed">{selectedProduct.description || "數位授權產品，自動發號。"}</p>
                                    <div className="grid grid-cols-2 gap-4 mb-10 text-center">
                                        <div className="bg-indigo-50 p-6 rounded-3xl"><p className="text-xs text-indigo-400 font-bold mb-1">售價</p><p className="text-3xl font-black text-indigo-600">NT$ {selectedProduct.price}</p></div>
                                        <div className="bg-slate-50 p-6 rounded-3xl"><p className="text-xs text-slate-400 font-bold mb-1">庫存</p><p className="text-3xl font-black text-slate-700">{getStockCount(selectedProduct.name)}</p></div>
                                    </div>
                                    <button onClick={() => setCartItem(selectedProduct)} disabled={getStockCount(selectedProduct.name) === 0} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:bg-indigo-600 transition-all shadow-xl active:scale-95 disabled:opacity-30">立即下單取號</button>
                                </div>
                            </div>
                        )}

                        {view === 'admin_products' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-black">商品目錄管理</h2><button onClick={() => {setEditingProduct(null); setIsProductModalOpen(true);}} className="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold">+ 新增商品</button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {products.map(p => (
                                        <div key={p.id} className="bg-white p-5 rounded-3xl border flex gap-4 items-center shadow-sm">
                                            <img src={p.image} className="w-20 h-20 rounded-2xl object-cover shadow-sm" />
                                            <div className="flex-1 min-w-0">
                                                <h4 className="font-bold truncate text-slate-700">{p.name}</h4>
                                                <p className="text-indigo-600 font-black text-sm">NT$ {p.price} | 在庫: {getStockCount(p.name)}</p>
                                                <div className="flex gap-2 mt-2">
                                                    <button onClick={() => {setEditingProduct(p); setIsProductModalOpen(true);}} className="p-2 bg-slate-50 rounded-lg text-slate-400 hover:text-indigo-600 transition-colors"><i className="fa-solid fa-pen"></i></button>
                                                    <button onClick={async () => { if(confirm("確定刪除？")) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('products').doc(p.id).delete(); }} className="p-2 bg-slate-50 rounded-lg text-slate-400 hover:text-red-500 transition-colors"><i className="fa-solid fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'admin_keys' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-black">序號資產管理</h2>
                                    <label className="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold text-sm cursor-pointer hover:bg-emerald-700 transition shadow-lg shadow-emerald-50">
                                        匯入 Excel 序號
                                        <input type="file" className="hidden" accept=".xlsx,.xls" onChange={async (e) => {
                                            const file = e.target.files[0];
                                            const reader = new FileReader();
                                            reader.onload = async (evt) => {
                                                const wb = XLSX.read(evt.target.result, { type: 'array' });
                                                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('keys');
                                                let count = 0;
                                                for (const row of data) {
                                                    const name = row['品名'] || row.productName || row.Product;
                                                    const key = row['序號'] || row.key || row.Key;
                                                    if (name && key) {
                                                        await col.add({ productName: String(name).trim(), key: String(key).trim(), status: 'available', importTime: new Date().toISOString() });
                                                        count++;
                                                    }
                                                }
                                                alert(`匯入完成！共計 ${count} 筆。`);
                                            };
                                            reader.readAsArrayBuffer(file);
                                        }} />
                                    </label>
                                </div>
                                <div className="bg-white rounded-3xl border overflow-hidden shadow-sm overflow-x-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b">
                                            <tr><th className="px-6 py-5">產品名稱</th><th className="px-6 py-5">序號代碼</th><th className="px-6 py-5">狀態</th><th className="px-6 py-5">匯入/售出時間</th></tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {inventory.length === 0 ? (
                                                <tr><td colSpan="4" className="text-center py-10 opacity-30">無序號紀錄。</td></tr>
                                            ) : (
                                                inventory.sort((a,b) => (b.importTime || "").localeCompare(a.importTime || "")).map(k => (
                                                    <tr key={k.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-6 py-4 font-bold text-slate-700">{k.productName}</td>
                                                        <td className="px-6 py-4 font-mono text-xs text-slate-500">{k.status === 'available' ? k.key : '****** (已售出)'}</td>
                                                        <td className="px-6 py-4"><span className={`px-2 py-0.5 rounded text-[10px] font-
