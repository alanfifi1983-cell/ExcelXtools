<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyHub Pro - 雲端序號銷售系統 (正式部署版)</title>
    <!-- 核心函式庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (Compat 模式) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 1. Firebase 配置金鑰
        // ==========================================
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC3ryVnW-6ZIG9ZuK56I9kNabcKOi89FUQ",
            authDomain: "bobo-f4afd.firebaseapp.com",
            projectId: "bobo-f4afd", 
            storageBucket: "bobo-f4afd.firebasestorage.app",
            messagingSenderId: "96116350820",
            appId: "1:96116350820:web:e6a8525c0283783209e471"
        };

        const App = () => {
            const [view, setView] = useState('login'); 
            const [appUser, setAppUser] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState('keyhub-pro-v1'); 
            const [errorMsg, setErrorMsg] = useState(null); 
            
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            
            const [masterProducts, setMasterProducts] = useState([]); 
            const [products, setProducts] = useState([]); 
            const [inventory, setInventory] = useState([]); 
            const [systemUsers, setSystemUsers] = useState([]); 
            
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [editingProduct, setEditingProduct] = useState(null);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            
            const [editingMaster, setEditingMaster] = useState(null); 
            const [isMasterModalOpen, setIsMasterModalOpen] = useState(false);
            
            const [editingUser, setEditingUser] = useState(null);
            const [isUserModalOpen, setIsUserModalOpen] = useState(false);
            
            const [inventoryTab, setInventoryTab] = useState('stock');
            const [searchTerm, setSearchTerm] = useState(''); 
            
            const [deleteConfirm, setDeleteConfirm] = useState({ show: false, id: null, type: '' });
            
            const [cartItem, setCartItem] = useState(null);
            const [emailInput, setEmailInput] = useState("");
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [imagePreview, setImagePreview] = useState("");
            const [lastSoldKey, setLastSoldKey] = useState(null); 
            const fileInputRef = useRef(null);

            const showToast = (message, type = 'info') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast({ show: false, message: '', type: 'info' }), 3000);
            };

            // --- 初始化 Firebase ---
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        if (!MY_FIREBASE_CONFIG.apiKey || MY_FIREBASE_CONFIG.apiKey.includes("你的API")) {
                            setErrorMsg("尚未設定 Firebase API Key。");
                            setLoading(false);
                            return;
                        }
                        if (!firebase.apps.length) firebase.initializeApp(MY_FIREBASE_CONFIG);
                        const auth = firebase.auth();
                        const firestore = firebase.firestore();
                        await auth.signInAnonymously();
                        setDb(firestore);
                        setupDataSync(firestore, appId);
                    } catch (err) {
                        setErrorMsg("系統連線失敗: " + err.message);
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            const setupDataSync = (dbInstance, id) => {
                const dataRef = dbInstance.collection('artifacts').doc(id).collection('public').doc('data');
                const handleError = (err) => console.error("Firestore Error:", err);

                dataRef.collection('master_products').onSnapshot(snap => {
                    setMasterProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, handleError);

                dataRef.collection('products').onSnapshot(snap => {
                    setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, handleError);

                dataRef.collection('keys').onSnapshot(snap => {
                    setInventory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, handleError);

                dataRef.collection('users').onSnapshot(async (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    for (const user of list) {
                        if (String(user.username || "").toLowerCase() === 'admin' && user.role !== 'admin') {
                            await dataRef.collection('users').doc(user.id).update({ role: 'admin' });
                        }
                    }
                    if (list.length === 0 || !list.some(u => String(u.username || "").toLowerCase() === 'admin')) {
                        try {
                            await dataRef.collection('users').add({ username: 'admin', password: '123', role: 'admin' });
                        } catch(e) {}
                    }
                    setSystemUsers(list);
                    setLoading(false);
                }, handleError);
            };

            // --- 計算屬性 ---
            const stockSummary = useMemo(() => {
                const summary = {};
                inventory.forEach(item => {
                    const sku = item.sku || "unknown";
                    const name = item.productName || "未知產品";
                    if (!summary[sku]) summary[sku] = { name, total: 0, available: 0, sold: 0 };
                    summary[sku].total++;
                    if (item.status === 'available') summary[sku].available++;
                    if (item.status === 'sold') summary[sku].sold++;
                });
                return summary;
            }, [inventory]);

            const getDisplayStockCount = (product) => {
                const actualInDb = stockSummary[product.sku]?.available || 0;
                if (product.listedQty !== undefined) {
                    return Math.min(actualInDb, product.listedQty);
                }
                return actualInDb;
            };

            const salesRecords = useMemo(() => {
                return inventory.filter(item => item.status === 'sold')
                    .sort((a, b) => (b.soldTime || "").localeCompare(a.soldTime || ""));
            }, [inventory]);

            const allInventoryKeys = useMemo(() => {
                return inventory.sort((a, b) => (b.importTime || "").localeCompare(a.importTime || ""));
            }, [inventory]);

            // --- 核心功能函數 ---

            const handleLogin = (e) => {
                e.preventDefault();
                const user = systemUsers.find(u => 
                    String(u.username || "").trim().toLowerCase() === loginForm.username.trim().toLowerCase() && 
                    String(u.password || "").trim() === loginForm.password.trim()
                );
                if (user) { 
                    setAppUser(user); 
                    setView('shop'); 
                } else {
                    showToast("帳號或密碼錯誤", "error");
                }
            };

            const handleSaveMasterProduct = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const mData = {
                    sku: formData.get('sku').trim().toUpperCase(),
                    name: formData.get('name').trim(),
                    basePrice: Number(formData.get('basePrice')),
                    image: imagePreview || '', 
                    description: formData.get('description'),
                    updatedAt: new Date().toISOString()
                };

                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('master_products');
                if (editingMaster) {
                    await col.doc(editingMaster.id).update(mData);
                    showToast("產品資料已更新");
                } else {
                    if (masterProducts.some(m => m.sku === mData.sku)) return showToast("此產品編號已存在", "error");
                    await col.add({ ...mData, createdAt: new Date().toISOString() });
                    showToast("產品已建立於庫中");
                }
                setIsMasterModalOpen(false);
                setEditingMaster(null);
                setImagePreview("");
            };

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const sku = formData.get('sku').trim();
                const master = masterProducts.find(m => m.sku === sku);

                const pData = {
                    sku: sku,
                    name: master ? master.name : '未知',
                    price: Number(formData.get('price')),
                    listedQty: Number(formData.get('listedQty')) || 0,
                    image: imagePreview || (master ? master.image : 'https://via.placeholder.com/300'), 
                    description: formData.get('description'),
                    isActive: formData.get('isActive') === 'on',
                    updatedAt: new Date().toISOString()
                };

                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('products');
                if (editingProduct) {
                    await col.doc(editingProduct.id).update(pData);
                    showToast("上架資訊已更新");
                } else {
                    await col.add({ ...pData, createdAt: new Date().toISOString() });
                    showToast("商品已發佈上架");
                }
                setIsProductModalOpen(false);
                setEditingProduct(null);
                setImagePreview("");
            };

            const handleSaveUser = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const username = formData.get('username').trim();
                
                let role = formData.get('role');
                if (!role && editingUser) role = editingUser.role;
                if (username.toLowerCase() === 'admin') role = 'admin';

                const uData = {
                    username: username,
                    password: formData.get('password').trim(),
                    role: role || 'sales'
                };
                
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');

                if (editingUser) {
                    try {
                        await col.doc(editingUser.id).update(uData);
                        showToast("帳號資訊已修改");
                        if (editingUser.id === appUser.id) setAppUser({ ...appUser, ...uData });
                    } catch (err) { showToast("修改失敗: " + err.message, "error"); }
                } else {
                    if (systemUsers.some(u => (u.username || "").toLowerCase() === uData.username.toLowerCase())) return showToast("該帳號已存在", "error");
                    await col.add(uData);
                    showToast("員工帳號已建立");
                }
                setIsUserModalOpen(false);
                setEditingUser(null);
                e.target.reset();
            };

            const handleDownloadTemplate = () => {
                const data = [
                    ["產品編號 (SKU)", "序號 (Key)"],
                    ["EXAMPLE-001", "ABCD-1234-EFGH"]
                ];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "匯入範例");
                XLSX.writeFile(wb, "KeyHub_匯入範例.xlsx");
            };

            const handleExcelImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'array' });
                        const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('keys');
                        let count = 0;
                        let skipped = 0;
                        for (const row of rawData) {
                            const keys = Object.keys(row);
                            const getNormalizedVal = (possibleHeaders) => {
                                const matchedKey = keys.find(k => possibleHeaders.includes(k.toString().replace(/\s+/g, '').toLowerCase()));
                                return matchedKey ? row[matchedKey] : null;
                            };
                            let skuRaw = getNormalizedVal(['sku', '產品編號', '編號', 'code', 'id']);
                            let keyVal = getNormalizedVal(['序號', 'key', 'serial', '代碼', '密碼']);
                            if (skuRaw && keyVal) {
                                const sku = String(skuRaw).trim().toUpperCase();
                                const master = masterProducts.find(m => m.sku === sku);
                                if (master) {
                                    await col.add({ 
                                        sku: sku,
                                        productName: master.name, 
                                        key: String(keyVal).trim(), 
                                        status: 'available', 
                                        importTime: new Date().toISOString() 
                                    });
                                    count++;
                                } else { skipped++; }
                            }
                        }
                        showToast(`匯入完成！成功：${count}，跳過：${skipped} (原因：編號不符)`, "info");
                    } catch (err) { showToast("Excel 解析失敗", "error"); }
                    e.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            };

            const handlePurchase = async () => {
                const keyDoc = inventory.find(k => k.sku === cartItem.sku && k.status === 'available');
                if (!keyDoc) return showToast("庫存已售完", "error");
                const invNo = `INV-${Date.now().toString().slice(-6)}`;
                const soldTime = new Date().toISOString();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('keys').doc(keyDoc.id).update({
                    status: 'sold', customerEmail: emailInput || "現場客戶", soldTime: soldTime, soldBy: appUser.username, invNo: invNo
                });
                const productRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('products').doc(cartItem.id);
                await productRef.update({ listedQty: Math.max(0, (cartItem.listedQty || 0) - 1) });
                setLastSoldKey({ key: keyDoc.key, productName: cartItem.name, price: cartItem.price, invNo: invNo, time: soldTime, seller: appUser.username });
                showToast("訂單已完成");
                setCartItem(null);
                setEmailInput("");
            };

            const confirmDeleteAction = async () => {
                const { id, type } = deleteConfirm;
                try {
                    let colName = '';
                    if (type === 'key') colName = 'keys';
                    else if (type === 'product') colName = 'products';
                    else if (type === 'master') colName = 'master_products';
                    else if (type === 'user') colName = 'users';
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(colName).doc(id).delete();
                    showToast("資料已永久刪除");
                } catch (err) { showToast("刪除失敗: " + err.message, "error"); }
                setDeleteConfirm({ show: false, id: null, type: '' });
            };

            const printReceipt = () => {
                if (!lastSoldKey) return;
                const printWin = window.open('', '', 'width=400,height=600');
                printWin.document.write(`<html><head><title>Receipt</title><style>body { font-family: sans-serif; padding: 10px; width: 75mm; margin: 0 auto; color: #000; }.center { text-align: center; }.divider { border-top: 1px dashed #000; margin: 8px 0; }.header { font-size: 18px; font-weight: bold; }.item-name { font-size: 14px; font-weight: bold; margin: 8px 0; }.serial-box { border: 2px solid #000; padding: 8px; margin: 10px 0; font-size: 18px; font-weight: 900; word-break: break-all; text-transform: uppercase; }.info { font-size: 11px; line-height: 1.4; }</style></head><body><div class="center header">KEYHUB PRO</div><div class="center info">數位授權產品收據</div><div class="divider"></div><div class="info">單號: ${lastSoldKey.invNo}<br>時間: ${new Date(lastSoldKey.time).toLocaleString()}<br>銷售: ${lastSoldKey.seller}</div><div class="divider"></div><div class="item-name">${lastSoldKey.productName}</div><div class="info">金額: NT$ ${lastSoldKey.price}</div><div class="center" style="margin-top:15px; font-size: 10px;">[ 產品兌換序號 ]</div><div class="center serial-box">${lastSoldKey.key}</div><div class="divider"></div><div class="center info" style="font-size:9px;">請妥善保管收據。<br>感謝購買！</div><script>window.onload = function() { window.print(); window.close(); }<\/script></body></html>`);
                printWin.document.close();
                setLastSoldKey(null);
            };

            const filteredMaster = masterProducts.filter(m => (m.sku || "").toUpperCase().includes(searchTerm.toUpperCase()) || (m.name || "").includes(searchTerm));
            const filteredProducts = products.filter(p => (p.sku || "").toUpperCase().includes(searchTerm.toUpperCase()) || (p.name || "").includes(searchTerm));
            const filteredAllKeys = allInventoryKeys.filter(k => (k.sku || "").toUpperCase().includes(searchTerm.toUpperCase()) || (k.productName || "").includes(searchTerm) || (k.key || "").includes(searchTerm));

            if (errorMsg) return (
                <div className="h-screen flex items-center justify-center bg-slate-100 p-6 text-center text-slate-800 animate-fade-in"><div className="bg-white p-8 rounded-3xl shadow-xl max-w-lg border border-red-100"><i className="fa-solid fa-triangle-exclamation text-red-500 text-5xl mb-4"></i><h2 className="text-xl font-bold mb-4">系統啟動中斷</h2><div className="bg-red-50 p-4 rounded-xl text-red-700 text-sm font-mono text-left mb-6 break-words whitespace-pre-wrap">{errorMsg}</div><button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-700">重新整理</button></div></div>
            );

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white text-center"><div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4 mx-auto text-indigo-500"></div><p className="font-bold tracking-widest opacity-60 italic">系統載入中...</p></div>
            );

            if (view === 'login') return (
                <div className="h-screen bg-slate-50 flex items-center justify-center p-6 text-center text-slate-800 font-sans"><div className="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-xl border border-slate-100 animate-fade-in"><div className="bg-indigo-600 w-16 h-16 rounded-2xl text-white flex items-center justify-center mx-auto mb-6 shadow-lg italic font-black text-2xl text-center flex items-center justify-center">KH</div><h1 className="text-3xl font-black mb-1 italic text-slate-800">KEYHUB <span className="text-indigo-600">PRO</span></h1><p className="text-slate-400 font-bold text-xs mb-8 uppercase tracking-widest leading-none">數位銷售端系統</p><form onSubmit={handleLogin} className="space-y-4 text-left"><input type="text" placeholder="帳號" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold transition-all" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} /><input type="password" placeholder="密碼" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold transition-all" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} /><button className="w-full py-5 bg-indigo-600 text-white font-black text-lg rounded-2xl hover:bg-indigo-700 shadow-xl transition-all active:scale-95 mt-4">登入</button></form></div></div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col text-slate-800 font-sans">
                    <nav className="bg-white border-b h-16 flex items-center px-6 justify-between sticky top-0 z-40 shadow-sm">
                        <div className="flex items-center gap-2 font-black text-xl cursor-pointer" onClick={() => setView('shop')}>
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white shadow-sm flex items-center justify-center"><i className="fa-solid fa-key text-sm"></i></div>
                            <span>KeyHub</span>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-xl gap-1">
                            <button onClick={() => setView('shop')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition ${view === 'shop' || view === 'detail' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>商店</button>
                            {appUser.role === 'admin' && (
                                <>
                                    <button onClick={() => {setView('admin_master_db'); setSearchTerm('');}} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition ${view === 'admin_master_db' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>產品庫</button>
                                    <button onClick={() => {setView('admin_products'); setSearchTerm('');}} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition ${view === 'admin_products' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>上架管理</button>
                                    <button onClick={() => {setView('admin_keys'); setSearchTerm('');}} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition ${view === 'admin_keys' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>庫存紀錄</button>
                                    <button onClick={() => setView('admin_accounts')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition ${view === 'admin_accounts' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>帳號</button>
                                </>
                            )}
                        </div>
                        <button onClick={() => { setAppUser(null); setView('login'); }} className="p-2 text-slate-400 hover:text-red-500 transition-colors"><i className="fa-solid fa-right-from-bracket"></i></button>
                    </nav>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-6 animate-fade-in text-left">
                        {view === 'shop' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                {products.length === 0 ? (<div className="col-span-full py-20 text-center opacity-30 italic font-bold">目前無上架商品。</div>) : (
                                    products.filter(p => p.isActive).map(p => (
                                        <div key={p.id} onClick={() => { setSelectedProduct(p); setView('detail'); }} className="bg-white p-3 rounded-3xl border border-slate-100 shadow-sm hover:shadow-lg transition-all cursor-pointer group">
                                            <div className="aspect-square rounded-2xl overflow-hidden bg-slate-100 mb-4"><img src={p.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" /></div>
                                            <div className="p-2">
                                                <h3 className="font-bold text-slate-800 truncate">{p.name}</h3>
                                                <div className="flex justify-between items-center mt-2">
                                                    <span className="text-indigo-600 font-black">NT$ {p.price}</span>
                                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${getDisplayStockCount(p) > 0 ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>在庫: {getDisplayStockCount(p)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === 'detail' && selectedProduct && (
                            <div className="max-w-5xl mx-auto bg-white rounded-[2.5rem] p-8 md:p-12 shadow-xl flex flex-col md:flex-row gap-12 items-center text-left text-slate-800">
                                <div className="w-full md:w-1/2 aspect-square rounded-[2rem] overflow-hidden shadow-2xl border-4 border-slate-50"><img src={selectedProduct.image} className="w-full h-full object-cover" /></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-start mb-4">
                                        <h2 className="text-5xl font-black text-slate-800 leading-tight">{selectedProduct.name}</h2>
                                        <button onClick={() => setView('shop')} className="text-slate-300 hover:text-indigo-600 transition-colors"><i className="fa-solid fa-circle-xmark text-3xl"></i></button>
                                    </div>
                                    <p className="text-slate-500 text-lg mb-8 leading-relaxed whitespace-pre-wrap">{selectedProduct.description || "數位產品授權，自動發號。"}</p>
                                    <div className="grid grid-cols-2 gap-4 mb-10 text-center">
                                        <div className="bg-indigo-50 p-6 rounded-3xl"><p className="text-xs text-indigo-400 font-bold mb-1 uppercase">售價</p><p className="text-3xl font-black text-indigo-600">NT$ {selectedProduct.price}</p></div>
                                        <div className="bg-slate-50 p-6 rounded-3xl"><p className="text-xs text-slate-400 font-bold mb-1 uppercase">可售數量</p><p className="text-3xl font-black text-slate-700">{getDisplayStockCount(selectedProduct)}</p></div>
                                    </div>
                                    <button onClick={() => setCartItem(selectedProduct)} disabled={getDisplayStockCount(selectedProduct) === 0} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:bg-indigo-600 transition-all shadow-xl active:scale-95 disabled:opacity-30">立即下單取號</button>
                                </div>
                            </div>
                        )}

                        {view === 'admin_master_db' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center flex-wrap gap-4 text-slate-800">
                                    <h2 className="text-2xl font-black text-left w-full sm:w-auto">產品資料庫</h2>
                                    <div className="flex gap-4 items-center w-full sm:w-auto">
                                        <div className="relative flex-1">
                                            <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                            <input type="text" placeholder="搜尋..." className="pl-10 pr-4 py-2 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all w-full text-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        </div>
                                        <button onClick={() => {setEditingMaster(null); setImagePreview(""); setIsMasterModalOpen(true);}} className="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition whitespace-nowrap text-sm">+ 新增基礎產品</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden overflow-x-auto text-slate-800">
                                    <table className="w-full text-left text-sm min-w-[700px]">
                                        <thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            <tr><th className="px-6 py-5">圖示</th><th className="px-6 py-5">編號 (SKU)</th><th className="px-6 py-5">名稱</th><th className="px-6 py-5">預設金額</th><th className="px-6 py-5 text-right">操作</th></tr>
                                        </thead>
                                        <tbody className="divide-y text-slate-600 font-medium">
                                            {filteredMaster.map(m => (
                                                <tr key={m.id} className="hover:bg-slate-50">
                                                    <td className="px-6 py-3"><img src={m.image} className="w-12 h-12 rounded-lg object-cover bg-slate-100" /></td>
                                                    <td className="px-6 py-4 font-black text-indigo-600">{m.sku}</td>
                                                    <td className="px-6 py-4 font-bold text-slate-800">{m.name}</td>
                                                    <td className="px-6 py-4 font-mono">NT$ {m.basePrice}</td>
                                                    <td className="px-6 py-4 text-right flex justify-end gap-2">
                                                        <button onClick={() => { setEditingMaster(m); setImagePreview(m.image); setIsMasterModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all"><i className="fa-solid fa-pen"></i></button>
                                                        <button onClick={() => setDeleteConfirm({ show: true, id: m.id, type: 'master' })} className="p-2 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all"><i className="fa-solid fa-trash-can"></i></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'admin_products' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center flex-wrap gap-4 text-slate-800">
                                    <h2 className="text-2xl font-black">商店上架管理</h2>
                                    <div className="flex gap-4 items-center w-full sm:w-auto">
                                        <div className="relative flex-1">
                                            <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                            <input type="text" placeholder="搜尋..." className="pl-10 pr-4 py-2 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all w-full text-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        </div>
                                        <button onClick={() => {setEditingProduct(null); setIsProductModalOpen(true); setImagePreview("");}} className="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition whitespace-nowrap text-sm">+ 上架商品</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredProducts.map(p => (
                                        <div key={p.id} className="bg-white p-5 rounded-3xl border flex gap-4 items-center shadow-sm text-slate-800">
                                            <img src={p.image} className="w-20 h-20 rounded-2xl object-cover shadow-sm bg-slate-50" />
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-start"><p className="text-[10px] font-black text-indigo-400 uppercase mb-1">{p.sku}</p><span className={`w-2 h-2 rounded-full ${p.isActive ? 'bg-green-500' : 'bg-slate-300'}`}></span></div>
                                                <h4 className="font-bold truncate text-slate-700">{p.name}</h4>
                                                <p className="text-indigo-600 font-black text-sm">NT$ {p.price}</p>
                                                <p className="text-slate-400 text-[10px] mt-1 font-bold">限額: {p.listedQty} / 在庫: {stockSummary[p.sku]?.available || 0}</p>
                                                <div className="flex gap-2 mt-2">
                                                    <button onClick={() => {setEditingProduct(p); setImagePreview(p.image); setIsProductModalOpen(true);}} className="p-1.5 bg-slate-50 rounded-lg text-slate-400 hover:text-indigo-600 transition-colors"><i className="fa-solid fa-pen text-xs"></i></button>
                                                    <button onClick={() => setDeleteConfirm({ show: true, id: p.id, type: 'product' })} className="p-1.5 bg-slate-50 rounded-lg text-slate-400 hover:text-red-500 transition-colors"><i className="fa-solid fa-trash text-xs"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'admin_keys' && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 text-slate-800">
                                    <div className="flex bg-white rounded-xl p-1 shadow-sm border overflow-hidden">
                                        <button onClick={() => setInventoryTab('stock')} className={`px-4 py-2 rounded-lg font-bold text-xs transition ${inventoryTab === 'stock' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>匯總</button>
                                        <button onClick={() => setInventoryTab('records')} className={`px-4 py-2 rounded-lg font-bold text-xs transition ${inventoryTab === 'records' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>銷售紀錄</button>
                                        <button onClick={() => setInventoryTab('all_keys')} className={`px-4 py-2 rounded-lg font-bold text-xs transition ${inventoryTab === 'all_keys' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>序號刪改</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2 items-center w-full md:w-auto">
                                        <div className="relative flex-1 min-w-[150px]"><i className="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i><input type="text" placeholder="搜尋..." className="pl-8 pr-4 py-2 rounded-xl border bg-white text-xs w-full focus:ring-1 focus:ring-indigo-500 outline-none transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                        <button onClick={handleDownloadTemplate} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-xs border hover:bg-slate-200 flex items-center gap-2 transition"><i className="fa-solid fa-download"></i> 範例</button>
                                        <label className="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-xs cursor-pointer hover:bg-emerald-700 shadow-lg flex items-center gap-2 transition whitespace-nowrap"><i className="fa-solid fa-file-excel"></i> 匯入 Excel<input type="file" className="hidden" accept=".xlsx,.xls" onChange={handleExcelImport} /></label>
                                    </div>
                                </div>
                                {inventoryTab === 'stock' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
                                        {Object.entries(stockSummary).map(([sku, stats]) => (
                                            <div key={sku} className="bg-white p-6 rounded-3xl border shadow-sm space-y-4 text-slate-800"><div><p className="text-[10px] font-black text-indigo-400 uppercase mb-1">{sku}</p><h3 className="font-black text-lg text-slate-700 truncate">{stats.name}</h3></div><div className="grid grid-cols-3 gap-2 text-center"><div className="p-2 bg-slate-50 rounded-xl"><p className="text-[10px] text-slate-400 font-bold uppercase">Total</p><p className="font-black">{stats.total}</p></div><div className="p-2 bg-green-50 rounded-xl"><p className="text-[10px] text-green-400 font-bold uppercase">Avail</p><p className="font-black text-green-600">{stats.available}</p></div><div className="p-2 bg-indigo-50 rounded-xl"><p className="text-[10px] text-indigo-400 font-bold uppercase">Sold</p><p className="font-black text-indigo-600">{stats.sold}</p></div></div></div>
                                        ))}
                                    </div>
                                )}
                                {inventoryTab === 'all_keys' && (
                                    <div className="bg-white rounded-3xl border overflow-hidden shadow-sm overflow-x-auto animate-fade-in text-slate-800">
                                        <table className="w-full text-left text-sm min-w-[700px]"><thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="px-6 py-5">產品</th><th className="px-6 py-5">序號</th><th className="px-6 py-5">狀態</th><th className="px-6 py-5">匯入時間</th><th className="px-6 py-5 text-right">操作</th></tr></thead><tbody className="divide-y text-slate-600 font-medium">{filteredAllKeys.map(k => (<tr key={k.id} className="hover:bg-slate-50"><td className="px-6 py-4"><p className="text-[10px] font-black text-indigo-300 mb-1">{k.sku}</p><p className="font-bold">{k.productName}</p></td><td className="px-6 py-4 font-mono text-xs">{k.key}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-[10px] font-black ${k.status === 'available' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}`}>{k.status === 'available' ? '在線' : '已售'}</span></td><td className="px-6 py-4 text-[10px] text-slate-400">{new Date(k.importTime).toLocaleString()}</td><td className="px-6 py-4 text-right"><button onClick={() => setDeleteConfirm({ show: true, id: k.id, type: 'key' })} className="p-2 text-slate-300 hover:text-red-600 transition-all"><i className="fa-solid fa-trash-can"></i></button></td></tr>))}</tbody></table>
                                    </div>
                                )}
                                {inventoryTab === 'records' && (
                                    <div className="bg-white rounded-3xl border overflow-hidden shadow-sm overflow-x-auto animate-fade-in text-slate-800">
                                        <table className="w-full text-left text-sm min-w-[700px]"><thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="px-6 py-5">產品</th><th className="px-6 py-5">序號</th><th className="px-6 py-5">單號</th><th className="px-6 py-5">銷售員</th><th className="px-6 py-5">成交時間</th></tr></thead><tbody className="divide-y text-slate-600 font-medium">{salesRecords.map(k => (<tr key={k.id} className="hover:bg-slate-50"><td className="px-6 py-4 font-bold">{k.productName}</td><td className="px-6 py-4 font-mono text-xs">{k.key}</td><td className="px-6 py-4 font-mono text-xs">{k.invNo}</td><td className="px-6 py-4"><span className="bg-indigo-50 text-indigo-600 px-2 py-1 rounded text-[10px] font-black">{k.soldBy}</span></td><td className="px-6 py-4 text-[10px] text-slate-400">{new Date(k.soldTime).toLocaleString()}</td></tr>))}</tbody></table>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'admin_accounts' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center text-slate-800">
                                    <h2 className="text-2xl font-black">帳號權限管理</h2>
                                    <button onClick={() => {setEditingUser(null); setIsUserModalOpen(true);}} className="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition">+ 新增使用者</button>
                                </div>
                                <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden overflow-x-auto text-slate-800 font-medium">
                                    <table className="w-full text-left text-sm min-w-[500px]">
                                        <thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            <tr><th className="px-6 py-5">帳號</th><th className="px-6 py-5">目前密碼</th><th className="px-6 py-5">角色</th><th className="px-6 py-5 text-right">操作</th></tr>
                                        </thead>
                                        <tbody className="divide-y text-slate-600">
                                            {systemUsers.map(u => (
                                                <tr key={u.id} className="hover:bg-slate-50">
                                                    <td className="px-6 py-4 font-bold text-slate-800">{u.username}</td>
                                                    <td className="px-6 py-4 font-mono text-xs text-slate-400">{u.password}</td>
                                                    <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-[10px] font-black uppercase ${u.role === 'admin' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-400'}`}>{u.role}</span></td>
                                                    <td className="px-6 py-4 text-right flex justify-end gap-2">
                                                        <button onClick={() => { setEditingUser(u); setIsUserModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="編輯帳號"><i className="fa-solid fa-user-gear"></i></button>
                                                        {String(u.username || "").toLowerCase() !== 'admin' && (<button onClick={() => setDeleteConfirm({ show: true, id: u.id, type: 'user' })} className="p-2 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all"><i className="fa-solid fa-trash-can"></i></button>)}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- 全域 Toast 通知 --- */}
                    {toast.show && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] animate-fade-in">
                            <div className={`px-6 py-3 rounded-2xl shadow-2xl font-bold text-white flex items-center gap-3 ${toast.type === 'error' ? 'bg-red-500' : 'bg-slate-800'}`}>
                                <i className={`fa-solid ${toast.type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check'}`}></i>
                                {toast.message}
                            </div>
                        </div>
                    )}

                    {/* --- 刪除確認 Modal --- */}
                    {deleteConfirm.show && (
                        <div className="fixed inset-0 z-[90] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in text-center text-slate-800">
                            <div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl border">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i className="fa-solid fa-trash-can"></i></div>
                                <h3 className="text-xl font-black mb-2 text-slate-800 text-center">確定要刪除嗎？</h3>
                                <p className="text-slate-400 text-sm mb-8 text-center">此操作將永久移除該筆資料。</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirm({ show: false, id: null, type: '' })} className="flex-1 py-3 font-bold text-slate-400">取消</button>
                                    <button onClick={confirmDeleteAction} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-black shadow-lg">確認刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 結帳與收據 Modal */}
                    {(cartItem || lastSoldKey) && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in text-slate-800 text-left">
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-white">
                                {!lastSoldKey ? (
                                    <>
                                        <h3 className="text-2xl font-black mb-6 tracking-tight text-slate-800">結帳確認</h3>
                                        <div className="bg-slate-50 p-5 rounded-[2rem] mb-6 flex gap-4 items-center border border-slate-100">
                                            <img src={cartItem.image} className="w-16 h-16 rounded-2xl object-cover shadow-sm" />
                                            <div><p className="font-bold">{cartItem.name}</p><p className="text-indigo-600 font-black text-xl">NT$ {cartItem.price}</p></div>
                                        </div>
                                        <div className="space-y-4 mb-8 text-left">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">顧客 Email (選填)</label>
                                            <input type="email" placeholder="example@gmail.com" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 outline-none focus:border-indigo-600 font-bold transition-all text-slate-800" value={emailInput} onChange={e => setEmailInput(e.target.value)} />
                                        </div>
                                        <div className="flex gap-3 text-center">
                                            <button onClick={() => setCartItem(null)} className="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 transition-colors">取消</button>
                                            <button onClick={handlePurchase} className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">確認下單</button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center animate-fade-in">
                                        <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm flex items-center justify-center"><i className="fa-solid fa-check"></i></div>
                                        <h3 className="text-2xl font-black mb-2 text-slate-800">交易完成</h3>
                                        <p className="text-slate-400 text-sm mb-8 font-bold">收據已準備完畢</p>
                                        <button onClick={printReceipt} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:bg-indigo-600 transition-all shadow-xl active:scale-95 mb-4 flex items-center justify-center gap-3">
                                            <i className="fa-solid fa-print"></i> 列印收據檔案
                                        </button>
                                        <button onClick={() => setLastSoldKey(null)} className="w-full py-3 text-slate-400 font-bold hover:text-slate-600 transition-colors">返回商店首頁</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* 產品資料庫 Modal */}
                    {isMasterModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in text-left">
                            <div className="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl text-slate-800 border overflow-y-auto max-h-[90vh]">
                                <h3 className="text-2xl font-black mb-6 flex items-center gap-2"><i className="fa-solid fa-database text-indigo-600"></i>產品基礎資料設定</h3>
                                <form onSubmit={handleSaveMasterProduct} className="space-y-6">
                                    <div className="flex flex-col items-center gap-4 p-6 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200">
                                        {imagePreview ? <img src={imagePreview} className="w-32 h-32 rounded-2xl object-cover shadow-md border-4 border-white" /> : <div className="w-32 h-32 bg-slate-100 rounded-2xl flex items-center justify-center"><i className="fa-solid fa-image text-4xl text-slate-200"></i></div>}
                                        <button type="button" onClick={() => fileInputRef.current.click()} className="text-xs font-bold bg-white px-5 py-2 rounded-xl border shadow-sm">上傳產品預設照片</button>
                                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setImagePreview(reader.result); reader.readAsDataURL(file); } }} />
                                    </div>
                                    <div className="space-y-4">
                                        <div><label className="text-xs font-black text-slate-400 uppercase">產品編號 (SKU)</label><input name="sku" defaultValue={editingMaster?.sku} required readOnly={!!editingMaster} placeholder="例如: GAME-01" className={`w-full p-4 rounded-2xl border outline-none font-black ${editingMaster ? 'bg-slate-50 text-slate-400' : 'bg-white focus:border-indigo-600'}`} /></div>
                                        <div><label className="text-xs font-black text-slate-400 uppercase">產品正式名稱</label><input name="name" defaultValue={editingMaster?.name} required className="w-full bg-slate-50 p-4 rounded-2xl border focus:border-indigo-600 font-bold outline-none" /></div>
                                        <div><label className="text-xs font-black text-slate-400 uppercase">基礎金額 (預設售價)</label><input name="basePrice" type="number" defaultValue={editingMaster?.basePrice} required className="w-full bg-slate-50 p-4 rounded-2xl border focus:border-indigo-600 font-bold text-indigo-600 outline-none" /></div>
                                    </div>
                                    <div className="flex gap-3"><button type="button" onClick={() => setIsMasterModalOpen(false)} className="flex-1 font-bold text-slate-400">取消</button><button type="submit" className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">確認儲存</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 上架 Modal */}
                    {isProductModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in text-left">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl overflow-y-auto max-h-[90vh] text-slate-800 border">
                                <h3 className="text-2xl font-black mb-6 flex items-center gap-2"><i className="fa-solid fa-cloud-arrow-up text-indigo-600"></i>上架新商品頁面</h3>
                                <form onSubmit={handleSaveProduct} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                        <div className="flex flex-col items-center gap-4 p-6 bg-slate-50 rounded-[2.5rem] border-2 border-dashed border-slate-200">
                                            {imagePreview ? <img src={imagePreview} className="w-full aspect-square rounded-[2rem] object-cover shadow-md border-4 border-white" /> : <div className="w-full aspect-square bg-slate-100 rounded-[2rem] flex items-center justify-center text-slate-200"><i className="fa-solid fa-image text-5xl text-slate-200"></i></div>}
                                            <p className="text-[10px] text-slate-400 italic text-center">由產品庫自動帶入，也可手動更改</p>
                                        </div>
                                        <div className="space-y-6">
                                            <div>
                                                <label className="text-xs font-black text-slate-400 uppercase">1. 選擇編號 (SKU)</label>
                                                <select name="sku" required defaultValue={editingProduct?.sku} className="w-full bg-white p-4 rounded-2xl border outline-none focus:border-indigo-600 font-black text-indigo-600 shadow-sm" onChange={(e) => {
                                                    const master = masterProducts.find(m => m.sku === e.target.value);
                                                    if(master && !editingProduct) {
                                                        const priceInput = e.target.form.elements['price'];
                                                        if(priceInput) priceInput.value = master.basePrice;
                                                        if(master.image) setImagePreview(master.image);
                                                    }
                                                }}>
                                                    <option value="">請選擇產品庫...</option>
                                                    {masterProducts.map(m => <option key={m.id} value={m.sku}>{m.sku} - {m.name}</option>)}
                                                </select>
                                                <div className="mt-2 flex justify-between items-center px-2">
                                                    <span className="text-[10px] text-slate-400 font-bold uppercase">目前可用庫存</span>
                                                    <span className="text-xs font-black text-green-600 bg-green-50 px-2 py-0.5 rounded-full">{stockSummary[editingProduct?.sku || '']?.available || 0}</span>
                                                </div>
                                            </div>
                                            <div><label className="text-xs font-black text-slate-400 uppercase">2. 設定本次上架價格</label><input name="price" type="number" defaultValue={editingProduct?.price} required className="w-full bg-slate-50 p-4 rounded-2xl border focus:border-indigo-600 font-black text-lg outline-none" /></div>
                                            <div><label className="text-xs font-black text-slate-400 uppercase">3. 上架限額 (數量)</label><input name="listedQty" type="number" defaultValue={editingProduct?.listedQty ?? 10} required className="w-full bg-slate-50 p-4 rounded-2xl border focus:border-indigo-600 font-black text-lg outline-none" /></div>
                                        </div>
                                    </div>
                                    <textarea name="description" rows="3" defaultValue={editingProduct?.description} placeholder="前台詳細說明..." className="w-full bg-slate-50 p-4 rounded-2xl border focus:border-indigo-600 font-medium outline-none text-slate-800" />
                                    <div className="flex items-center gap-3 bg-indigo-50 p-5 rounded-2xl border border-indigo-100 text-slate-800"><input name="isActive" type="checkbox" id="active-check" defaultChecked={editingProduct?.isActive ?? true} className="w-5 h-5 accent-indigo-600" /><label htmlFor="active-check" className="text-sm font-bold text-indigo-700 cursor-pointer">立即發佈至商店前台</label></div>
                                    <div className="flex gap-4 pt-4 text-center"><button type="button" onClick={() => setIsProductModalOpen(false)} className="flex-1 font-bold text-slate-400">取消</button><button type="submit" className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">確認儲存</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 帳號 Modal */}
                    {isUserModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in text-slate-800 text-left border">
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl border">
                                <div className="flex justify-between items-start mb-6">
                                    <h3 className="text-2xl font-black tracking-tight">{editingUser ? '編輯帳號權限' : '新增系統帳號'}</h3>
                                    <button onClick={() => {setIsUserModalOpen(false); setEditingUser(null);}} className="text-slate-300 hover:text-slate-500"><i className="fa-solid fa-xmark text-2xl"></i></button>
                                </div>
                                <form onSubmit={handleSaveUser} className="space-y-5">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left block">帳號名稱</label>
                                        <input name="username" defaultValue={editingUser?.username} readOnly={!!editingUser} required className={`w-full p-4 rounded-2xl border-2 outline-none font-bold transition-all ${editingUser ? 'bg-slate-50 border-transparent text-slate-400' : 'bg-white border-slate-100 focus:border-indigo-600'}`} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left block">密碼設定</label>
                                        <input name="password" defaultValue={editingUser?.password} required placeholder="請輸入密碼" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold text-slate-600" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left block">權限角色</label>
                                        <select name="role" defaultValue={editingUser?.role || 'sales'} disabled={editingUser && String(editingUser.username || "").toLowerCase() === 'admin'} className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold text-slate-600">
                                            <option value="sales">銷售人員 (Sales)</option>
                                            <option value="admin">管理人員 (Admin)</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-4 pt-4 text-center">
                                        <button type="button" onClick={() => {setIsUserModalOpen(false); setEditingUser(null);}} className="flex-1 font-bold text-slate-400 hover:text-slate-600 transition-colors">取消</button>
                                        <button type="submit" className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">確認修改</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
