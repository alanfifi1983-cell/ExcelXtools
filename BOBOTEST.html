<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeyHub Pro - 雲端序號銷售系統 (PC/手機完美導覽版)</title>
    <!-- 核心函式庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.FB = { initializeApp, getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, addDoc, updateDoc, deleteDoc, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* 手機端橫向捲動選單 */
        .mobile-nav-scroll { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; display: flex; gap: 8px; }
        .mobile-nav-scroll::-webkit-scrollbar { display: none; }

        /* 輸入框強化 */
        input, select { font-size: 16px !important; } 
        
        @media print { .no-print { display: none; } }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            // --- 1. 配置與連線設定 ---
            const MY_FIXED_CONFIG = {
                apiKey: "AIzaSyAP2xmHPo_WzD13yTQtgVgWo1uB99-kZ5M",
                authDomain: "bobotest2-2e8f8.firebaseapp.com",
                projectId: "bobotest2-2e8f8",
                storageBucket: "bobotest2-2e8f8.firebasestorage.app",
                messagingSenderId: "668437841672",
                appId: "1:668437841672:web:96267f4d108822161a4ebd"
            };

            const firebaseConfig = MY_FIXED_CONFIG;
            const appId = 'keyhub-pro-v1'; 

            // --- 2. 狀態管理 ---
            const [view, setView] = useState('login'); 
            const [user, setUser] = useState(null); 
            const [fbUser, setFbUser] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [db, setDb] = useState(null);
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            
            const [masterProducts, setMasterProducts] = useState([]); 
            const [products, setProducts] = useState([]); 
            const [inventory, setInventory] = useState([]); 
            const [systemUsers, setSystemUsers] = useState([]); 
            const [settings, setSettings] = useState({
                printWidth: 50, printHeight: 70, storeName: 'KEYHUB STORE', showProductImage: true
            });

            const [searchTerm, setSearchTerm] = useState('');
            const [inventoryTab, setInventoryTab] = useState('records');
            const [isMasterModalOpen, setIsMasterModalOpen] = useState(false);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [isUserModalOpen, setIsUserModalOpen] = useState(false);
            
            const [editingMaster, setEditingMaster] = useState(null); 
            const [editingProduct, setEditingProduct] = useState(null); 
            const [editingUser, setEditingUser] = useState(null); 
            
            const [listingData, setListingData] = useState({ sku: '', price: 0, listedQty: 0, isActive: true });
            const [imagePreview, setImagePreview] = useState("");
            const [deleteConfirm, setDeleteConfirm] = useState({ show: false, id: null, type: '' });
            
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [cartItem, setCartItem] = useState(null);
            const [purchaseQty, setPurchaseQty] = useState(1); 
            const [checkoutStep, setCheckoutStep] = useState(1);
            const [emailInput, setEmailInput] = useState("");
            const [soldResults, setSoldResults] = useState([]); 
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });

            const fileInputRef = useRef(null);

            const showToast = (message, type = 'info') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast({ show: false, message: '', type: 'info' }), 3500);
            };

            // --- 重要：瀏覽器導覽邏輯 (History API) ---
            const navigateTo = (nextView, replace = false) => {
                if (replace) {
                    window.history.replaceState({ view: nextView }, '', '#' + nextView);
                } else {
                    window.history.pushState({ view: nextView }, '', '#' + nextView);
                }
                setView(nextView);
            };

            useEffect(() => {
                const handlePopState = (event) => {
                    if (event.state && event.state.view) {
                        setView(event.state.view);
                    } else if (user) {
                        setView('shop');
                    } else {
                        setView('login');
                    }
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [user]);

            // --- 3. Firebase 初始化 ---
            useEffect(() => {
                const initApp = async () => {
                    try {
                        const app = FB.initializeApp(firebaseConfig);
                        const auth = FB.getAuth(app);
                        const firestore = FB.getFirestore(app);
                        setDb(firestore);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await FB.signInWithCustomToken(auth, __initial_auth_token); } 
                            catch (e) { await FB.signInAnonymously(auth); }
                        } else { await FB.signInAnonymously(auth); }
                        FB.onAuthStateChanged(auth, (u) => { if (u) setFbUser(u); });
                    } catch (err) {
                        setLoading(false);
                    }
                };
                initApp();
            }, []);

            // --- 4. 資料監聽 ---
            useEffect(() => {
                if (!fbUser || !db) return;
                const publicPath = ['artifacts', appId, 'public', 'data'];
                const unsubM = FB.onSnapshot(FB.collection(db, ...publicPath, 'master_products'), s => setMasterProducts(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubP = FB.onSnapshot(FB.collection(db, ...publicPath, 'products'), s => setProducts(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubK = FB.onSnapshot(FB.collection(db, ...publicPath, 'keys'), s => setInventory(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubU = FB.onSnapshot(FB.collection(db, ...publicPath, 'users'), s => {
                    setSystemUsers(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                });
                return () => { unsubM(); unsubP(); unsubK(); unsubU(); };
            }, [fbUser, db]);

            useEffect(() => {
                if (!user || !db) return;
                const privateSettingsPath = ['artifacts', appId, 'users', user.id, 'settings', 'printConfig'];
                const unsubSettings = FB.onSnapshot(FB.doc(db, ...privateSettingsPath), d => {
                    if (d.exists()) setSettings(prev => ({...prev, ...d.data()}));
                    else setSettings({ printWidth: 50, printHeight: 70, storeName: 'MY STORE', showProductImage: true });
                });
                return () => unsubSettings();
            }, [user, db]);

            // --- 5. 數據計算邏輯 ---
            const stockSummary = useMemo(() => {
                const summary = {};
                inventory.forEach(item => {
                    const sku = item.sku || "unknown";
                    if (!summary[sku]) summary[sku] = { name: item.productName || "未知產品", total: 0, available: 0, sold: 0 };
                    summary[sku].total++;
                    if (item.status === 'available') summary[sku].available++;
                    if (item.status === 'sold') summary[sku].sold++;
                });
                return summary;
            }, [inventory]);

            const salesRecords = useMemo(() => {
                let records = inventory.filter(item => item.status === 'sold');
                if (user && user.role !== 'admin') {
                    const myName = user.realName || user.username;
                    records = records.filter(item => item.soldBy === myName);
                }
                if (searchTerm) {
                    const low = searchTerm.toLowerCase();
                    records = records.filter(r => r.productName?.toLowerCase().includes(low) || r.invNo?.toLowerCase().includes(low) || r.key?.toLowerCase().includes(low));
                }
                return records.sort((a, b) => (b.soldTime || "").localeCompare(a.soldTime || ""));
            }, [inventory, user, searchTerm]);

            const filteredAllKeys = useMemo(() => {
                const low = searchTerm.toLowerCase();
                return inventory.filter(k => k.key?.toLowerCase().includes(low) || k.productName?.toLowerCase().includes(low) || k.sku?.toLowerCase().includes(low))
                    .sort((a,b) => (b.importTime || "").localeCompare(a.importTime || ""));
            }, [inventory, searchTerm]);

            const getDisplayStockCount = (product) => {
                if (!product) return 0;
                const avail = stockSummary[product.sku]?.available || 0;
                return product.listedQty !== undefined ? Math.min(avail, product.listedQty) : avail;
            };

            const filteredMaster = useMemo(() => masterProducts.filter(m => m.sku?.toLowerCase().includes(searchTerm.toLowerCase()) || m.name?.toLowerCase().includes(searchTerm.toLowerCase())), [masterProducts, searchTerm]);

            // --- 6. 功能處理函數 ---

            const handleLogin = (e) => {
                e.preventDefault();
                const { username, password } = loginForm;
                if (systemUsers.length === 0 && username === 'admin' && password === 'admin') {
                    const adminUser = { id: 'initial-admin', username: 'admin', realName: '系統管理員', role: 'admin', canReprint: true };
                    setUser(adminUser);
                    navigateTo('shop', true);
                    return;
                }
                const matched = systemUsers.find(u => u.username?.toLowerCase() === username.toLowerCase() && u.password === password);
                if (matched) { 
                    setUser(matched); 
                    navigateTo('shop', true); 
                    if(matched.role !== 'admin') setInventoryTab('records');
                } else showToast("帳號或密碼錯誤", "error");
            };

            const handleSavePersonalSettings = async (e) => {
                e.preventDefault();
                if (!user || !db) return;
                const fd = new FormData(e.target);
                const data = { 
                    storeName: fd.get('storeName').trim(), 
                    printWidth: Number(fd.get('printWidth')), 
                    printHeight: Number(fd.get('printHeight')), 
                    showProductImage: fd.get('showProductImage') === 'on' 
                };
                try {
                    await FB.setDoc(FB.doc(db, 'artifacts', appId, 'users', user.id, 'settings', 'printConfig'), data);
                    showToast("帳號專屬設定已存檔");
                } catch (e) { showToast("儲存失敗", "error"); }
            };

            const handleReprintAction = async (record) => {
                const reprintTime = new Date().toISOString();
                const reprintUser = user.realName || user.username;
                try {
                    await FB.updateDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'keys', record.id), { reprintTime, reprintUser });
                    const m = masterProducts.find(x => x.sku === record.sku);
                    setSoldResults([{ ...record, price: record.productPrice || 'N/A', seller: record.soldBy, time: record.soldTime, image: m?.image || '', reprintTime, reprintUser }]);
                    showToast("已產生補印單據");
                } catch (err) { showToast("錯誤", "error"); }
            };

            const handlePurchase = async () => {
                const availableKeys = inventory.filter(k => k.sku === cartItem.sku && k.status === 'available').slice(0, purchaseQty);
                if (availableKeys.length < purchaseQty) return showToast("庫存不足", "error");
                const soldTime = new Date().toISOString();
                const seller = user.realName || user.username;
                const results = [];
                try {
                    for (let i = 0; i < availableKeys.length; i++) {
                        const k = availableKeys[i];
                        const invNo = `INV-${Date.now().toString().slice(-6)}-${i+1}`;
                        await FB.updateDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'keys', k.id), { 
                            status: 'sold', customerEmail: emailInput || "現場客戶", soldTime, soldBy: seller, invNo, productPrice: cartItem.price 
                        });
                        results.push({ key: k.key, productName: cartItem.name, price: cartItem.price, invNo, time: soldTime, seller, image: cartItem.image });
                    }
                    await FB.updateDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'products', cartItem.id), { listedQty: Math.max(0, (cartItem.listedQty || 0) - purchaseQty) });
                    setSoldResults(results);
                    setCartItem(null); setCheckoutStep(1); setEmailInput(""); setPurchaseQty(1);
                } catch (err) { showToast("交易失敗", "error"); }
            };

            const printReceipts = () => {
                if (soldResults.length === 0) return;
                const { printWidth: pW, printHeight: pH, storeName, showProductImage } = settings;
                const win = window.open('', '', `width=450,height=650`);
                const style = `
                    @page { size: ${pW}mm ${pH}mm; margin: 0; }
                    * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
                    body { margin: 0; padding: 4mm; font-family: sans-serif; font-size: 8.5px; color: #000; display: flex; flex-direction: column; page-break-after: always; overflow: hidden; background: #fff; }
                    .center { text-align: center; }
                    .key-box { border: 1.2px solid #000; padding: 2mm 1mm; margin: 1mm 0; font-size: 11px; font-weight: 900; text-align: center; background: #f4f4f4; text-transform: uppercase; word-break: break-all; }
                    .footer { font-size: 6px; text-align: center; margin-top: auto; border-top: 0.5px solid #eee; padding-top: 1mm; }
                `;
                let html = `<html><head><style>${style}</style></head><body>`;
                soldResults.forEach(item => {
                    const timeStr = new Date(item.time).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
                    html += `
                        <div class="receipt">
                            <div class="center" style="font-size:13px; font-weight:900">${storeName}</div>
                            <div class="center" style="font-size:7px;border-bottom:0.5px solid #000;padding-bottom:1mm">數位授權收據 ${item.reprintTime ? '(補印)' : ''}</div>
                            <div style="font-size:6.5px;margin-top:1mm">單號: ${item.invNo}</div>
                            <div style="font-size:6.5px">時間: ${timeStr}</div>
                            <div style="font-size:6.5px">經手: ${item.seller}</div>
                            <div style="border-top:0.8px dashed #000; margin:1.5mm 0"></div>
                            ${showProductImage && item.image ? `<img src="${item.image}" style="max-width:100%; max-height:14mm; display:block; margin:1mm auto">` : ''}
                            <div style="font-weight:800; font-size:10px">${item.productName}</div>
                            <div style="font-weight:900">金額: NT$ ${item.price}</div>
                            <div class="center" style="font-size:7px;font-weight:bold;margin-top:1mm">[ 兌換序號 ]</div>
                            <div class="key-box">${item.key}</div>
                            ${item.reprintTime ? `<div style="font-size:5px;color:#666;margin-top:0.5mm">補印人: ${item.reprintUser} / ${new Date(item.reprintTime).toLocaleString()}</div>` : ''}
                            <div class="footer">請妥善保管。序號售出不予退換。</div>
                        </div>
                    `;
                });
                html += `<script>window.onload=()=>{window.print();setTimeout(()=>window.close(),500);}<\/script></body></html>`;
                win.document.write(html); win.document.close(); setSoldResults([]);
            };

            const handleExcelImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        let count = 0;
                        for (const row of data) {
                            const sku = (row['產品編號'] || row['SKU'] || "").toString().trim().toUpperCase();
                            const key = (row['序號'] || row['Key'] || "").toString().trim();
                            const master = masterProducts.find(m => m.sku === sku);
                            if (sku && key && master) {
                                await FB.addDoc(FB.collection(db, 'artifacts', appId, 'public', 'data', 'keys'), { sku, productName: master.name, key, status: 'available', importTime: new Date().toISOString() });
                                count++;
                            }
                        }
                        showToast(`成功匯入 ${count} 筆序號`);
                    } catch (e) { showToast("解析失敗", "error"); }
                    e.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDownloadTemplate = () => {
                const data = [["產品編號", "序號"], ["SOFT-SKU-001", "ABCD-1234"]];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "範本");
                XLSX.writeFile(wb, "KeyHub_序號範本.xlsx");
            };

            const BarcodeUI = ({ code }) => {
                const svgRef = useRef();
                useEffect(() => { if (svgRef.current && code) JsBarcode(svgRef.current, code, { format: "CODE128", width: 2, height: 40, displayValue: true }); }, [code]);
                return <svg ref={svgRef} className="max-w-full h-auto"></svg>;
            };

            const handleListingSkuChange = (skuVal) => {
                const masterMatch = masterProducts.find(m => m.sku === skuVal.toUpperCase());
                const availableStock = stockSummary[skuVal.toUpperCase()]?.available || 0;
                setListingData(prev => ({
                    ...prev,
                    sku: skuVal.toUpperCase(),
                    price: masterMatch ? masterMatch.basePrice : prev.price,
                    listedQty: Math.min(prev.listedQty, availableStock)
                }));
                if (masterMatch && masterMatch.image) setImagePreview(masterMatch.image);
            };

            // --- 渲染部分 ---
            if (loading) return <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white font-black"><div className="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div><p className="opacity-40 text-xs tracking-widest uppercase">KEYHUB SYSTEM LOADING</p></div>;

            if (view === 'login') return (
                <div className="h-screen bg-slate-50 flex items-center justify-center p-6 text-center text-slate-800">
                    <div className="bg-white w-full max-w-md p-8 sm:p-10 rounded-[2.5rem] shadow-2xl border animate-fade-in">
                        <div className="bg-indigo-600 w-14 h-14 rounded-2xl text-white flex items-center justify-center mx-auto mb-6 shadow-lg text-xl font-black italic">KH</div>
                        <h1 className="text-2xl font-black mb-1 italic uppercase text-center">KeyHub <span className="text-indigo-600">Pro</span></h1>
                        <p className="text-slate-400 font-bold text-[10px] mb-8 tracking-widest uppercase text-center">Cloud License Management</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" placeholder="帳號" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} required />
                            <input type="password" placeholder="密碼" className="w-full bg-slate-50 p-4 rounded-2xl border-2 border-transparent focus:border-indigo-600 outline-none font-bold" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} required />
                            <button className="w-full py-5 bg-indigo-600 text-white font-black text-lg rounded-2xl hover:bg-indigo-700 active:scale-95 transition-all mt-4">進入系統</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#f8fafc] flex flex-col text-slate-800">
                    {/* 重要：手機響應式導覽選單 */}
                    <nav className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg cursor-pointer" onClick={() => navigateTo('shop')}>
                                <div className="bg-indigo-600 p-2 rounded-xl text-white"><i className="fa-solid fa-key text-xs"></i></div>
                                <span className="hidden sm:inline text-slate-800">KeyHub <span className="text-indigo-600">Pro</span></span>
                            </div>
                            
                            {/* 滑動式功能按鈕列 */}
                            <div className="flex-1 flex justify-center px-4 overflow-hidden">
                                <div className="mobile-nav-scroll bg-slate-100 p-1 rounded-xl">
                                    <button onClick={() => navigateTo('shop')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'shop' || view === 'detail' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>商店</button>
                                    {user.role === 'admin' && (
                                        <>
                                            <button onClick={() => navigateTo('admin_master_db')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'admin_master_db' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>產品庫</button>
                                            <button onClick={() => navigateTo('admin_products')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'admin_products' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>上架管理</button>
                                            <button onClick={() => navigateTo('admin_accounts')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'admin_accounts' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>帳號</button>
                                        </>
                                    )}
                                    <button onClick={() => navigateTo('admin_keys')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'admin_keys' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>{user.role === 'admin' ? '庫存紀錄' : '我的紀錄'}</button>
                                    <button onClick={() => navigateTo('admin_settings')} className={`px-4 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition ${view === 'admin_settings' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>設定</button>
                                </div>
                            </div>
                            
                            <button onClick={() => setUser(null) || navigateTo('login')} className="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 flex items-center justify-center border shadow-sm transition-all"><i className="fa-solid fa-power-off text-xs"></i></button>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6 animate-fade-in safe-area-bottom">
                        {/* 商店首頁 */}
                        {view === 'shop' && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
                                {products.filter(p => p.isActive).map(p => (
                                    <div key={p.id} onClick={() => { setSelectedProduct(p); navigateTo('detail'); }} className="bg-white p-3 rounded-2xl sm:rounded-3xl border shadow-sm hover:shadow-xl transition-all cursor-pointer group">
                                        <div className="aspect-square rounded-xl sm:rounded-2xl overflow-hidden bg-slate-100 mb-3 border flex items-center justify-center text-slate-200">
                                            {p.image ? <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform" /> : <i className="fa-solid fa-image text-3xl"></i>}
                                        </div>
                                        <h3 className="font-bold text-slate-800 truncate text-xs sm:text-sm px-1">{p.name}</h3>
                                        <div className="flex justify-between items-center text-[10px] font-bold px-1 mt-2">
                                            <span className="text-indigo-600">NT$ {p.price}</span>
                                            <span className={getDisplayStockCount(p) > 0 ? 'text-emerald-500' : 'text-red-400'}>庫存:{getDisplayStockCount(p)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 產品詳情頁 */}
                        {view === 'detail' && selectedProduct && (
                            <div className="max-w-4xl mx-auto bg-white rounded-3xl p-6 sm:p-12 shadow-2xl flex flex-col md:flex-row gap-8 sm:gap-12 items-center border animate-fade-in text-slate-800">
                                <div className="w-full md:w-5/12 aspect-square rounded-[2rem] overflow-hidden shadow-xl border"><img src={selectedProduct.image || 'https://via.placeholder.com/600'} className="w-full h-full object-cover" /></div>
                                <div className="flex-1 w-full text-center md:text-left">
                                    <div className="flex justify-between items-start mb-6"><h2 className="text-3xl sm:text-4xl font-black leading-tight">{selectedProduct.name}</h2><button onClick={() => window.history.back()} className="text-slate-300 hover:text-indigo-600"><i className="fa-solid fa-circle-xmark text-3xl"></i></button></div>
                                    <p className="text-slate-400 text-sm mb-8 italic border-l-4 border-indigo-500 pl-4 leading-relaxed text-left">數位產品授權，結帳後系統將為您派發序號。</p>
                                    <div className="grid grid-cols-2 gap-4 mb-10 text-center">
                                        <div className="bg-indigo-50 p-6 rounded-3xl"><p className="text-[10px] text-indigo-400 font-black uppercase mb-1 tracking-widest">售價</p><p className="text-2xl font-black text-indigo-600">NT$ {selectedProduct.price}</p></div>
                                        <div className="bg-slate-50 p-6 rounded-3xl"><p className="text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest">可用</p><p className="text-2xl font-black text-slate-700">{getDisplayStockCount(selectedProduct)}</p></div>
                                    </div>
                                    <button onClick={() => { setCartItem(selectedProduct); setCheckoutStep(1); setPurchaseQty(1); }} disabled={getDisplayStockCount(selectedProduct) === 0} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:bg-indigo-600 transition-all shadow-xl active:scale-95 disabled:opacity-30">立即下單購買</button>
                                </div>
                            </div>
                        )}

                        {/* 重要修復：庫存紀錄渲染塊 (補齊空白邏輯) */}
                        {view === 'admin_keys' && (
                             <div className="space-y-6 animate-fade-in text-slate-800">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div className="flex bg-white rounded-xl p-1 shadow-sm border overflow-x-auto w-full md:w-auto hide-scrollbar">
                                        {user.role === 'admin' && <button onClick={() => setInventoryTab('stock')} className={`px-4 py-2 rounded-lg font-bold text-xs whitespace-nowrap transition ${inventoryTab === 'stock' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>庫存匯總</button>}
                                        <button onClick={() => setInventoryTab('records')} className={`px-4 py-2 rounded-lg font-bold text-xs whitespace-nowrap transition ${inventoryTab === 'records' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>銷售紀錄</button>
                                        {user.role === 'admin' && <button onClick={() => setInventoryTab('all_keys')} className={`px-4 py-2 rounded-lg font-bold text-xs whitespace-nowrap transition ${inventoryTab === 'all_keys' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500'}`}>序號清單</button>}
                                    </div>
                                    <input type="text" placeholder="搜尋紀錄..." className="w-full md:w-64 pl-4 py-2 rounded-xl border bg-white text-xs font-bold focus:border-indigo-600 outline-none shadow-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                </div>

                                {inventoryTab === 'records' && (
                                    <div className="bg-white rounded-3xl border shadow-sm overflow-hidden overflow-x-auto animate-fade-in">
                                        <table className="w-full text-left text-sm min-w-[900px]">
                                            <thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 uppercase tracking-widest text-left">
                                                <tr><th className="px-6 py-5">成交時間</th><th className="px-6 py-5">產品名稱</th><th className="px-6 py-5">單號</th><th className="px-6 py-5">人員</th><th className="px-6 py-5 text-indigo-400 uppercase tracking-tighter">最後補印紀錄</th><th className="px-6 py-5 text-right">操作</th></tr>
                                            </thead>
                                            <tbody className="divide-y font-bold">
                                                {salesRecords.length === 0 ? <tr><td colSpan="6" className="py-20 text-center opacity-20 italic">尚無相關紀錄。</td></tr> : 
                                                    salesRecords.map(k => (
                                                        <tr key={k.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="px-6 py-4 text-slate-400 text-xs font-mono">{new Date(k.soldTime).toLocaleString()}</td>
                                                            <td className="px-6 py-4">{k.productName}</td>
                                                            <td className="px-6 py-4 text-indigo-400 font-mono text-xs">{k.invNo}</td>
                                                            <td className="px-6 py-4">{k.soldBy}</td>
                                                            <td className="px-6 py-4">{k.reprintTime ? <div className="text-[9px] leading-tight italic text-slate-500">由: {k.reprintUser}<br/>{new Date(k.reprintTime).toLocaleString()}</div> : '-'}</td>
                                                            <td className="px-6 py-4 text-right">{(user.role === 'admin' || user.canReprint) && <button onClick={() => handleReprintAction(k)} className="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] hover:bg-indigo-600 transition-all shadow-md">補印</button>}</td>
                                                        </tr>
                                                    ))
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {inventoryTab === 'stock' && user.role === 'admin' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in text-slate-800">
                                        {Object.entries(stockSummary).map(([sku, stats]) => (
                                            <div key={sku} className="bg-white p-6 rounded-[2rem] border shadow-sm hover:shadow-md transition-all">
                                                <p className="text-[10px] font-black text-indigo-400 uppercase mb-1 tracking-widest leading-none">{sku}</p>
                                                <h3 className="font-black text-lg text-slate-800 truncate mb-4">{stats.name}</h3>
                                                <div className="grid grid-cols-3 gap-3 font-bold">
                                                    <div className="bg-slate-50 p-3 rounded-2xl text-center"><p className="text-[9px] opacity-40 uppercase">總量</p><p>{stats.total}</p></div>
                                                    <div className="bg-emerald-50 p-3 rounded-2xl text-center text-emerald-600"><p className="text-[9px] uppercase">在庫</p><p>{stats.available}</p></div>
                                                    <div className="bg-indigo-50 p-3 rounded-2xl text-center text-indigo-600"><p className="text-[9px] uppercase">已售</p><p>{stats.sold}</p></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {inventoryTab === 'all_keys' && user.role === 'admin' && (
                                    <div className="bg-white rounded-3xl border shadow-sm overflow-hidden animate-fade-in overflow-x-auto text-slate-800">
                                        <div className="p-4 bg-slate-50 border-b flex justify-between items-center min-w-[600px]"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">全序號明細</span><div className="flex gap-2"><button onClick={handleDownloadTemplate} className="text-[10px] bg-white border px-3 py-1 rounded-lg">範本</button><label className="text-[10px] bg-emerald-600 text-white px-3 py-1 rounded-lg cursor-pointer">匯入<input type="file" className="hidden" accept=".xlsx,.xls" onChange={handleExcelImport} /></label></div></div>
                                        <table className="w-full text-left text-sm min-w-[600px]"><thead className="bg-slate-100 text-[9px] font-black text-slate-400 tracking-widest uppercase"><tr><th className="px-6 py-4">SKU</th><th className="px-6 py-4">序號內容</th><th className="px-6 py-4 text-center">狀態</th><th className="px-6 py-4 text-right">管理</th></tr></thead><tbody className="divide-y font-bold">{filteredAllKeys.map(k => (<tr key={k.id} className="hover:bg-slate-50 transition-colors"><td className="px-6 py-3 text-[10px]">{k.sku}</td><td className="px-6 py-3 font-mono text-indigo-600 uppercase">{k.key}</td><td className="px-6 py-3 text-center"><span className={`px-2 py-0.5 rounded text-[9px] ${k.status === 'available' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>{k.status === 'available' ? '在庫' : '已售'}</span></td><td className="px-6 py-3 text-right"><button onClick={() => setDeleteConfirm({show: true, id: k.id, type: 'key'})} className="text-red-200 hover:text-red-500 transition-all"><i className="fa-solid fa-trash-can text-xs"></i></button></td></tr>))}</tbody></table>
                                    </div>
                                )}
                             </div>
                        )}

                        {/* 個人設定頁面 (徹底帳號隔離) */}
                        {view === 'admin_settings' && (
                             <div className="max-w-xl mx-auto space-y-6 animate-fade-in text-slate-800">
                                <h2 className="text-2xl font-black">帳號設定</h2>
                                <form onSubmit={handleSavePersonalSettings} className="bg-white p-6 sm:p-8 rounded-[2.5rem] border shadow-sm space-y-6 font-bold text-sm">
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase tracking-widest">收據顯示商店名稱</label><input name="storeName" defaultValue={settings.storeName} className="w-full bg-slate-50 p-4 rounded-2xl border outline-none focus:border-indigo-600" required /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">列印寬度 (mm)</label><input name="printWidth" type="number" defaultValue={settings.printWidth} className="w-full bg-slate-50 p-4 rounded-2xl border" /></div>
                                        <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">列印高度 (mm)</label><input name="printHeight" type="number" defaultValue={settings.printHeight} className="w-full bg-slate-50 p-4 rounded-2xl border" /></div>
                                    </div>
                                    <div className="flex items-center gap-3 px-2 py-1"><input name="showProductImage" type="checkbox" id="set-img" defaultChecked={settings.showProductImage} className="w-5 h-5 accent-indigo-600" /><label htmlFor="set-img" className="text-xs font-black text-indigo-700 cursor-pointer">在收據上顯示產品圖片</label></div>
                                    <button type="submit" className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">儲存目前帳號設定</button>
                                    <div className="bg-slate-50 p-4 rounded-2xl text-center"><p className="text-[9px] text-slate-400 uppercase tracking-tighter italic">此設定僅保存在帳號: {user?.realName || user?.username}</p></div>
                                </form>
                             </div>
                        )}

                        {/* 管理員介面：產品庫 (補全 UI) */}
                        {view === 'admin_master_db' && user.role === 'admin' && (
                             <div className="space-y-6 animate-fade-in text-slate-800">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-black">產品資料庫</h2><button onClick={() => {setEditingMaster(null); setImagePreview(""); setIsMasterModalOpen(true);}} className="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg text-xs">+ 新增產品</button></div>
                                <div className="bg-white rounded-3xl border shadow-sm overflow-hidden overflow-x-auto">
                                    <table className="w-full text-left text-sm min-w-[650px]"><thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 tracking-widest uppercase"><tr><th className="px-6 py-5">圖示</th><th className="px-6 py-5">SKU</th><th className="px-6 py-5">名稱</th><th className="px-6 py-5 text-right">管理</th></tr></thead><tbody className="divide-y font-bold">{filteredMaster.map(m => (<tr key={m.id} className="hover:bg-slate-50 transition-colors"><td className="px-6 py-3"><img src={m.image} className="w-10 h-10 rounded-lg object-cover bg-slate-100 border shadow-sm" /></td><td className="px-6 py-4 text-indigo-600 font-black uppercase text-[11px]">{m.sku}</td><td className="px-6 py-4 text-slate-800">{m.name}</td><td className="px-6 py-4 text-right"><button onClick={() => { setEditingMaster(m); setImagePreview(m.image); setIsMasterModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 transition-all"><i className="fa-solid fa-pen-to-square"></i></button><button onClick={() => setDeleteConfirm({show: true, id: m.id, type: 'master'})} className="p-2 text-red-200 hover:text-red-500 transition-all ml-1"><i className="fa-solid fa-trash-can"></i></button></td></tr>))}</tbody></table>
                                </div>
                            </div>
                        )}

                        {/* 上架管理 (管理員) */}
                        {view === 'admin_products' && user.role === 'admin' && (
                             <div className="space-y-6 animate-fade-in text-slate-800">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-black">上架管理</h2><button onClick={() => {setEditingProduct(null); setListingData({ sku: '', price: 0, listedQty: 0, isActive: true }); setImagePreview(""); setIsProductModalOpen(true);}} className="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg text-xs">+ 上架新商品</button></div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">{products.map(p => (<div key={p.id} className="bg-white p-5 rounded-[2rem] border flex gap-4 items-center shadow-sm group hover:shadow-md transition-all"><img src={p.image} className="w-16 h-16 rounded-xl object-cover border" /><div className="flex-1 min-w-0"><div className="flex justify-between items-center mb-1"><p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest truncate">{p.sku}</p><span className={`w-2 h-2 rounded-full ${p.isActive ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}`}></span></div><h4 className="font-bold truncate text-sm text-slate-800 mb-1">{p.name}</h4><p className="text-indigo-600 font-black text-sm uppercase">NT$ {p.price}</p><div className="flex gap-2 mt-2 font-bold text-[11px] text-slate-400"><button onClick={() => {setEditingProduct(p); setListingData({ sku: p.sku, price: p.price, listedQty: p.listedQty, isActive: p.isActive }); setImagePreview(p.image); setIsProductModalOpen(true);}} className="hover:text-indigo-600 transition-all underline">編輯</button><button onClick={() => setDeleteConfirm({show: true, id: p.id, type: 'product'})} className="hover:text-red-500 transition-all underline">下架</button></div></div></div>))}</div>
                             </div>
                        )}

                        {/* 帳號管理 (管理員) */}
                        {view === 'admin_accounts' && user.role === 'admin' && (
                             <div className="space-y-6 animate-fade-in text-slate-800">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-black">人員管理</h2><button onClick={() => {setEditingUser(null); setIsUserModalOpen(true);}} className="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg text-xs">+ 新增帳號</button></div>
                                <div className="bg-white rounded-3xl border shadow-sm overflow-hidden overflow-x-auto"><table className="w-full text-left text-sm min-w-[600px]"><thead className="bg-slate-50 border-b text-[10px] font-black text-slate-400 tracking-widest uppercase"><tr><th className="px-6 py-5">帳號</th><th className="px-6 py-5">姓名</th><th className="px-6 py-5 text-center">角色</th><th className="px-6 py-5 text-center">補印</th><th className="px-6 py-5 text-right">操作</th></tr></thead><tbody className="divide-y font-bold">{systemUsers.map(u => (<tr key={u.id} className="hover:bg-slate-50 transition-colors"><td className="px-6 py-4">{u.username}</td><td className="px-6 py-4 text-indigo-600">{u.realName}</td><td className="px-6 py-4 text-center uppercase text-[10px]">{u.role === 'admin' ? '管理員' : '銷售員'}</td><td className="px-6 py-4 text-center">{u.canReprint ? '✅' : '❌'}</td><td className="px-6 py-4 text-right"><button onClick={() => { setEditingUser(u); setIsUserModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 transition-all mr-1"><i className="fa-solid fa-user-pen"></i></button><button onClick={() => setDeleteConfirm({show: true, id: u.id, type: 'user'})} className="p-2 text-red-200 hover:text-red-500 transition-all"><i className="fa-solid fa-trash"></i></button></td></tr>))}</tbody></table></div>
                             </div>
                        )}
                    </main>

                    {/* --- 重要修復：所有功能視窗 (補齊關閉按鈕與取消路徑) --- */}

                    {/* 結帳視窗 */}
                    {(cartItem || soldResults.length > 0) && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in text-center text-slate-800">
                            <div className="bg-white w-full max-w-md rounded-3xl p-6 sm:p-8 shadow-2xl border text-left max-h-[95vh] overflow-y-auto relative">
                                <button onClick={() => {setCartItem(null); setSoldResults([]);}} className="absolute top-4 right-4 text-slate-300 hover:text-slate-600 no-print transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                {soldResults.length === 0 ? (
                                    <div className="space-y-5">
                                        <h3 className="text-xl font-black text-center">{checkoutStep === 1 ? "結帳驗證" : "下單設定"}</h3>
                                        {checkoutStep === 1 ? (
                                            <div className="space-y-6 text-center font-bold">
                                                <div className="flex flex-col items-center bg-white p-3 rounded-2xl border-2 border-slate-100 shadow-inner overflow-hidden"><BarcodeUI code={cartItem.sku} /></div>
                                                <div className="bg-slate-50 p-4 rounded-3xl flex gap-4 items-center border text-sm">
                                                    <img src={cartItem.image} className="w-14 h-14 rounded-2xl object-cover border shadow-sm" />
                                                    <div className="flex-1 min-w-0 text-left"><p className="truncate font-black text-slate-700">{cartItem.name}</p><p className="text-indigo-600 font-black text-lg uppercase">NT$ {cartItem.price}</p></div>
                                                </div>
                                                <div className="flex gap-3"><button onClick={() => setCartItem(null)} className="flex-1 py-4 text-slate-400 font-black uppercase tracking-widest">取消</button><button onClick={() => setCheckoutStep(2)} className="flex-[2] py-4 bg-slate-900 text-white rounded-2xl shadow-lg font-black active:scale-95 transition-all">確認掃描完成</button></div>
                                            </div>
                                        ) : (
                                            <div className="space-y-5 animate-fade-in font-bold text-left">
                                                <button onClick={() => setCheckoutStep(1)} className="text-xs text-indigo-500 underline mb-2 tracking-tight">返回修改單號</button>
                                                <div className="space-y-2"><label className="text-[10px] text-slate-400 ml-1 uppercase tracking-widest">購買數量 (在庫:{getDisplayStockCount(cartItem)})</label>
                                                    <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-2xl border shadow-inner">
                                                        <button onClick={() => setPurchaseQty(Math.max(1, purchaseQty-1))} className="w-12 h-12 rounded-xl bg-white border shadow-sm flex items-center justify-center text-xl font-black">-</button>
                                                        <input type="number" value={purchaseQty} readOnly className="flex-1 text-center bg-transparent font-black text-2xl" />
                                                        <button onClick={() => setPurchaseQty(Math.min(getDisplayStockCount(cartItem), purchaseQty+1))} className="w-12 h-12 rounded-xl bg-white border shadow-sm flex items-center justify-center text-xl font-black">+</button>
                                                    </div>
                                                </div>
                                                <div className="bg-indigo-50 p-4 rounded-2xl flex justify-between items-center border border-indigo-100 shadow-sm"><span className="text-xs text-indigo-400 font-black uppercase">應付總額</span><span className="text-indigo-600 font-black text-2xl tracking-tighter uppercase">NT$ {cartItem.price * purchaseQty}</span></div>
                                                <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">顧客 Email (選填)</label><input type="email" placeholder="example@gmail.com" className="w-full bg-slate-50 p-4 rounded-2xl border font-bold outline-none focus:border-indigo-600 transition-all shadow-inner" value={emailInput} onChange={e => setEmailInput(e.target.value)} /></div>
                                                <div className="flex gap-3 pt-2"><button onClick={() => setCartItem(null)} className="flex-1 py-5 text-slate-400 font-black uppercase tracking-widest">取消</button><button onClick={handlePurchase} className="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl shadow-xl font-black active:scale-95 transition-all uppercase tracking-widest">確認購買並發序</button></div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center animate-fade-in space-y-6">
                                        <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-3xl shadow-inner"><i className="fa-solid fa-check"></i></div>
                                        <h3 className="text-xl font-black">下單成功 (共 {soldResults.length} 組)</h3>
                                        <div className="max-h-[160px] overflow-y-auto space-y-2 border-b pb-4 pr-1">
                                            {soldResults.map((item, idx) => (<div key={idx} className="bg-slate-50 p-3 rounded-xl border text-left font-mono text-[10px] font-black text-indigo-600 uppercase break-all shadow-inner tracking-tighter">#{idx+1}: {item.key}</div>))}
                                        </div>
                                        <div className="space-y-2 font-black">
                                            <button onClick={printReceipts} className="w-full py-4 bg-indigo-600 text-white rounded-2xl text-lg shadow-xl flex items-center justify-center gap-3 transition-all active:scale-95"><i className="fa-solid fa-print"></i> 列印所有收據</button>
                                            <button onClick={() => setSoldResults([])} className="w-full py-2 text-slate-400 text-xs transition-colors font-black uppercase tracking-widest">點此關閉視窗</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* 產品編輯視窗 (全適配) */}
                    {isMasterModalOpen && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in text-left text-slate-800">
                            <div className="bg-white w-full max-w-lg rounded-3xl p-6 sm:p-10 shadow-2xl border max-h-[90vh] overflow-y-auto relative">
                                <button onClick={() => setIsMasterModalOpen(false)} className="absolute top-4 right-4 text-slate-300 hover:text-slate-600"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                <h3 className="text-2xl font-black mb-8 flex items-center gap-3"><i className="fa-solid fa-database text-indigo-600"></i>產品主檔</h3>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    const data = { sku: fd.get('sku').trim().toUpperCase(), name: fd.get('name').trim(), basePrice: Number(fd.get('basePrice')), image: imagePreview || '', updatedAt: new Date().toISOString() };
                                    try {
                                        const path = ['artifacts', appId, 'public', 'data', 'master_products'];
                                        if (editingMaster) await FB.updateDoc(FB.doc(db, ...path, editingMaster.id), data);
                                        else await FB.addDoc(FB.collection(db, ...path), {...data, createdAt: new Date().toISOString()});
                                        setIsMasterModalOpen(false); showToast("主檔已同步");
                                    } catch (err) { showToast("錯誤", "error"); }
                                }} className="space-y-6 font-bold">
                                    <div className="flex flex-col items-center gap-4 p-5 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                                        {imagePreview ? <img src={imagePreview} className="w-24 h-24 object-cover rounded-xl shadow-sm border-2 border-white" /> : <div className="w-24 h-24 bg-slate-100 rounded-xl flex items-center justify-center text-slate-300 font-black italic">無圖</div>}
                                        <button type="button" onClick={() => fileInputRef.current.click()} className="text-[10px] bg-white px-4 py-2 rounded-xl border text-indigo-600 hover:bg-indigo-50 transition-all uppercase tracking-widest shadow-sm">選擇圖片</button>
                                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={e => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = () => setImagePreview(r.result); r.readAsDataURL(f); } }} />
                                    </div>
                                    <div className="space-y-4">
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">SKU 編號</label><input name="sku" defaultValue={editingMaster?.sku} required readOnly={!!editingMaster} className={`w-full p-4 rounded-2xl border ${editingMaster ? 'bg-slate-100 text-slate-400' : 'bg-white focus:border-indigo-600'}`} /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">產品名稱</label><input name="name" defaultValue={editingMaster?.name} required placeholder="例如: Office 2024" className="w-full p-4 rounded-2xl border outline-none focus:border-indigo-600" /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">建議售價</label><input name="basePrice" type="number" defaultValue={editingMaster?.basePrice} className="w-full p-4 rounded-2xl border text-indigo-600 font-black outline-none focus:border-indigo-600" /></div>
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setIsMasterModalOpen(false)} className="flex-1 py-4 text-slate-400 font-black uppercase tracking-widest">取消</button>
                                        <button type="submit" className="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-all">確認儲存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 上架設定 (全適配) */}
                    {isProductModalOpen && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in text-left text-slate-800">
                            <div className="bg-white w-full max-w-lg rounded-3xl p-6 sm:p-10 shadow-2xl border max-h-[90vh] overflow-y-auto relative">
                                <button onClick={() => setIsProductModalOpen(false)} className="absolute top-4 right-4 text-slate-300 hover:text-slate-600 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                <h3 className="text-xl font-black mb-8 flex items-center gap-3 text-slate-800"><i className="fa-solid fa-cloud-arrow-up text-indigo-600"></i>商店上架設定</h3>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    const sku = fd.get('sku').toUpperCase();
                                    const master = masterProducts.find(m => m.sku === sku);
                                    const availStock = stockSummary[sku]?.available || 0;
                                    const inputQty = Number(fd.get('listedQty'));
                                    if (!master) return showToast("找不到 SKU", "error");
                                    if (inputQty > availStock) return showToast(`超過庫存上限 (${availStock})`, "error");
                                    const data = { sku, name: master.name, price: Number(fd.get('price')), listedQty: inputQty, isActive: fd.get('isActive') === 'on', image: master.image || "", updatedAt: new Date().toISOString() };
                                    try {
                                        const path = ['artifacts', appId, 'public', 'data', 'products'];
                                        if (editingProduct) await FB.updateDoc(FB.doc(db, ...path, editingProduct.id), data);
                                        else await FB.addDoc(FB.collection(db, ...path), {...data, createdAt: new Date().toISOString()});
                                        setIsProductModalOpen(false); showToast("上架已更新");
                                    } catch (err) { showToast("錯誤", "error"); }
                                }} className="space-y-5 font-bold">
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">產品 SKU</label>
                                        <input name="sku" list="sku-list" placeholder="輸入或選擇 SKU..." defaultValue={editingProduct?.sku} readOnly={!!editingProduct} onChange={(e) => handleListingSkuChange(e.target.value)} className={`w-full p-4 rounded-2xl border ${editingProduct ? 'bg-slate-50' : 'bg-white focus:border-indigo-600'} transition-all`} required />
                                        <datalist id="sku-list">{masterProducts.map(m => <option key={m.id} value={m.sku}>{m.name}</option>)}</datalist>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">商店售價</label><input name="price" type="number" value={listingData.price} onChange={(e) => setListingData({...listingData, price: Number(e.target.value)})} className="w-full p-4 rounded-2xl border text-indigo-600 font-black outline-none" required /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">上架數量 (Max: {stockSummary[listingData.sku]?.available || 0})</label><input name="listedQty" type="number" value={listingData.listedQty} onChange={(e) => setListingData({...listingData, listedQty: Number(e.target.value)})} className="w-full p-4 rounded-2xl border outline-none shadow-inner" required /></div>
                                    </div>
                                    <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 flex items-center gap-3"><input name="isActive" type="checkbox" id="act-p" checked={listingData.isActive} onChange={e => setListingData({...listingData, isActive: e.target.checked})} className="w-5 h-5 accent-indigo-600" /><label htmlFor="act-p" className="text-xs font-black text-indigo-700 tracking-widest uppercase">發佈並顯示於商店前端</label></div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setIsProductModalOpen(false)} className="flex-1 py-5 text-slate-400 font-black uppercase tracking-widest transition-colors">取消</button>
                                        <button type="submit" className="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-all uppercase tracking-widest">儲存變更</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 人員編輯視窗 (管理員) */}
                    {isUserModalOpen && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in text-left text-slate-800">
                            <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl border relative">
                                <button onClick={() => setIsUserModalOpen(false)} className="absolute top-4 right-4 text-slate-300 hover:text-slate-600 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                <h3 className="text-xl font-black mb-8 flex items-center gap-3 text-slate-800"><i className="fa-solid fa-user-shield text-indigo-600"></i>帳號權限管理</h3>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    const data = { username: fd.get('username').trim().toLowerCase(), password: fd.get('password').trim(), realName: fd.get('realName').trim(), role: fd.get('role'), canReprint: fd.get('canReprint') === 'on' };
                                    try {
                                        const path = ['artifacts', appId, 'public', 'data', 'users'];
                                        if (editingUser) await FB.updateDoc(FB.doc(db, ...path, editingUser.id), data);
                                        else await FB.addDoc(FB.collection(db, ...path), data);
                                        setIsUserModalOpen(false); showToast("帳號資訊已同步");
                                    } catch (err) { showToast("錯誤", "error"); }
                                }} className="space-y-4 font-bold text-sm">
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">登入帳號</label><input name="username" defaultValue={editingUser?.username} required readOnly={!!editingUser} placeholder="帳號 ID" className={`w-full p-4 rounded-2xl border ${editingUser ? 'bg-slate-100 text-slate-400' : 'bg-white focus:border-indigo-600'} transition-all`} /></div>
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">人員顯示姓名</label><input name="realName" defaultValue={editingUser?.realName} required placeholder="姓名" className="w-full p-4 rounded-2xl border outline-none focus:border-indigo-600 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">密碼</label><input name="password" type="text" defaultValue={editingUser?.password} required placeholder="密碼" className="w-full p-4 rounded-2xl border outline-none focus:border-indigo-600 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 ml-1 uppercase">系統權限</label><select name="role" defaultValue={editingUser?.role || 'sales'} className="w-full bg-slate-50 p-4 rounded-2xl border font-black transition-all"><option value="sales">一般銷售員 (Sales)</option><option value="admin">系統管理員 (Admin)</option></select></div>
                                    <div className="flex items-center gap-3 px-2 py-1"><input name="canReprint" type="checkbox" id="rep-u" defaultChecked={editingUser?.canReprint} className="w-5 h-5 accent-indigo-600" /><label htmlFor="rep-u" className="text-xs font-black text-indigo-700">允許此帳號補印收據功能</label></div>
                                    <div className="flex gap-3 pt-4">
                                        <button type="button" onClick={() => setIsUserModalOpen(false)} className="flex-1 py-5 text-slate-400 font-black uppercase tracking-widest transition-colors">取消</button>
                                        <button type="submit" className="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-all">儲存並同步</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 刪除確認 */}
                    {deleteConfirm.show && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 text-center text-slate-800">
                            <div className="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl border font-bold animate-fade-in relative">
                                <button onClick={() => setDeleteConfirm({show:false, id:null, type:''})} className="absolute top-4 right-4 text-slate-300 hover:text-slate-600"><i className="fa-solid fa-xmark text-xl"></i></button>
                                <h3 className="text-lg font-black mb-6 leading-tight">確定要永久移除<br/>此資料嗎？</h3>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirm({show:false, id:null, type:''})} className="flex-1 py-4 text-slate-400 font-black uppercase tracking-widest">取消操作</button>
                                    <button onClick={async () => { 
                                        try { 
                                            const col = deleteConfirm.type === 'key' ? 'keys' : deleteConfirm.type === 'product' ? 'products' : deleteConfirm.type === 'user' ? 'users' : 'master_products'; 
                                            await FB.deleteDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', col, deleteConfirm.id)); 
                                            showToast("資料已刪除"); 
                                        } catch (e) { showToast("錯誤", "error"); } 
                                        setDeleteConfirm({show:false, id:null, type:''}); 
                                    }} className="flex-1 py-4 bg-red-500 text-white rounded-xl shadow-lg active:scale-95 transition-all font-black uppercase tracking-widest">確定刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast 訊息 */}
                    {toast.show && (
                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[200] animate-fade-in px-4 w-full max-w-xs">
                            <div className={`py-4 px-6 rounded-2xl shadow-2xl font-black text-white text-center text-sm ${toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-amber-500' : 'bg-slate-900'}`}>{toast.message}</div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
