<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 單檔多倉比對工具 (缺漏分析版)</title>
    
    <!-- 載入必要的函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="file"] { display: none; }
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const XLSX = window.XLSX;

        // --- Icons ---
        const Icons = {
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:bg-gray-100",
                danger: "bg-red-50 text-red-600 hover:bg-red-100"
            };
            return <button onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>{children}</button>;
        };

        function App() {
            const [step, setStep] = useState(1);
            const [isLoading, setIsLoading] = useState(false);

            // Files
            const [masterFile, setMasterFile] = useState(null);
            const [sourceFile, setSourceFile] = useState(null);

            // Master Data
            const [masterData, setMasterData] = useState([]);
            const [masterHeaders, setMasterHeaders] = useState([]);
            const [masterKeyCol, setMasterKeyCol] = useState('');
            const [masterSortCol, setMasterSortCol] = useState('');

            // Source Data
            const [sourceData, setSourceData] = useState([]);
            const [sourceHeaders, setSourceHeaders] = useState([]);
            const [sourceKeyCol, setSourceKeyCol] = useState('');
            const [sourceValCol, setSourceValCol] = useState('');
            
            // Warehouse (Group) Logic
            const [whCol, setWhCol] = useState('');
            const [availableWarehouses, setAvailableWarehouses] = useState([]); 
            const [selectedWarehouses, setSelectedWarehouses] = useState([]); 

            // Results
            const [mergedData, setMergedData] = useState([]);
            const [missingData, setMissingData] = useState({}); // { 'WarehouseA': [Row1...], ... }
            const [allMissingData, setAllMissingData] = useState([]); // [Row1, Row2...]
            const [finalHeaderOrder, setFinalHeaderOrder] = useState([]);

            // 1. Helpers
            const readFile = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wb = XLSX.read(e.target.result, { type: 'binary' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws);
                        const headers = XLSX.utils.sheet_to_json(ws, { header: 1 })[0] || [];
                        resolve({ json, headers });
                    };
                    reader.readAsBinaryString(file);
                });
            };

            const handleMasterUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    setMasterFile(file);
                    const { json, headers } = await readFile(file);
                    setMasterData(json);
                    setMasterHeaders(headers);
                    // Auto guess
                    const k = headers.find(h => /id|sku|part|no|料號|編號/i.test(h));
                    if(k) setMasterKeyCol(k);
                    const v = headers.find(h => /qty|stock|count|amount|數量|庫存/i.test(h));
                    if(v) setMasterSortCol(v);
                }
            };

            const handleSourceUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    setSourceFile(file);
                    const { json, headers } = await readFile(file);
                    setSourceData(json);
                    setSourceHeaders(headers);
                    // Auto guess
                    const k = headers.find(h => /id|sku|part|no|料號|編號/i.test(h));
                    if(k) setSourceKeyCol(k);
                    const v = headers.find(h => /qty|stock|count|amount|數量|庫存/i.test(h));
                    if(v) setSourceValCol(v);
                    const w = headers.find(h => /wh|ware|site|store|loc|倉|店/i.test(h));
                    if(w) setWhCol(w);
                }
            };

            // 2. Scan unique warehouses when whCol changes
            useEffect(() => {
                if(whCol && sourceData.length > 0) {
                    const unique = [...new Set(sourceData.map(row => row[whCol]).filter(v => v !== undefined && v !== null && String(v).trim() !== ''))];
                    unique.sort();
                    setAvailableWarehouses(unique);
                    setSelectedWarehouses(unique); // Default select all
                } else {
                    setAvailableWarehouses([]);
                    setSelectedWarehouses([]);
                }
            }, [whCol, sourceData]);

            // 3. Process Logic
            const handleProcess = () => {
                setIsLoading(true);
                setTimeout(() => {
                    try {
                        // A. Index Source Data
                        const whMap = {};
                        selectedWarehouses.forEach(wh => whMap[wh] = new Map());

                        sourceData.forEach(row => {
                            const wh = row[whCol];
                            if (selectedWarehouses.includes(wh)) {
                                const key = row[sourceKeyCol] !== undefined ? String(row[sourceKeyCol]).trim() : null;
                                const val = row[sourceValCol];
                                if (key) whMap[wh].set(key, val);
                            }
                        });

                        // B. Process Master Data
                        const resultRows = JSON.parse(JSON.stringify(masterData));
                        const missingGroups = {}; 
                        selectedWarehouses.forEach(wh => missingGroups[wh] = []);
                        
                        const globalMissingList = []; // Stores rows missing in ALL selected warehouses

                        resultRows.forEach(row => {
                            const mKey = row[masterKeyCol] !== undefined ? String(row[masterKeyCol]).trim() : "UNDEFINED";
                            
                            if (mKey !== "UNDEFINED") {
                                let missingInThisRow = 0; // Count missing for this item

                                selectedWarehouses.forEach(wh => {
                                    const sourceVal = whMap[wh].get(mKey);
                                    
                                    if (sourceVal !== undefined) {
                                        row[wh] = sourceVal;
                                    } else {
                                        missingGroups[wh].push(row);
                                        missingInThisRow++;
                                    }
                                });

                                // If missing count equals number of selected warehouses, it's missing everywhere
                                if (missingInThisRow === selectedWarehouses.length) {
                                    globalMissingList.push(row);
                                }
                            }
                        });

                        // D. Reorder Columns
                        let newHeaderOrder = [];
                        if (masterSortCol && masterHeaders.includes(masterSortCol)) {
                            const idx = masterHeaders.indexOf(masterSortCol) + 1;
                            newHeaderOrder = [
                                ...masterHeaders.slice(0, idx),
                                ...selectedWarehouses, 
                                ...masterHeaders.slice(idx)
                            ];
                        } else {
                            newHeaderOrder = [...masterHeaders, ...selectedWarehouses];
                        }

                        const reorderedData = resultRows.map(row => {
                            const newRow = {};
                            newHeaderOrder.forEach(h => newRow[h] = row[h]);
                            return newRow;
                        });

                        setMergedData(reorderedData);
                        setMissingData(missingGroups);
                        setAllMissingData(globalMissingList); // Save global missing
                        setFinalHeaderOrder(newHeaderOrder);
                        setStep(3);

                    } catch(e) {
                        console.error(e);
                        alert("處理發生錯誤，請檢查設定與檔案內容");
                    } finally {
                        setIsLoading(false);
                    }
                }, 200);
            };

            // 4. Download
            const downloadReport = () => {
                const wb = XLSX.utils.book_new();

                // Sheet 1: Master Merged
                const wsMerged = XLSX.utils.json_to_sheet(mergedData, { header: finalHeaderOrder });
                XLSX.utils.book_append_sheet(wb, wsMerged, "總表_庫存比對");

                // Sheet: Global Missing (New)
                if (allMissingData.length > 0) {
                     const wsAllMissing = XLSX.utils.json_to_sheet(allMissingData, { header: masterHeaders });
                     XLSX.utils.book_append_sheet(wb, wsAllMissing, "全部缺貨");
                }

                // Sheets 2...N: Missing items for each warehouse
                selectedWarehouses.forEach(wh => {
                    const missingRows = missingData[wh];
                    if (missingRows && missingRows.length > 0) {
                        const wsMissing = XLSX.utils.json_to_sheet(missingRows, { header: masterHeaders });
                        const safeName = wh.replace(/[*?\/\[\]\\]/g, '').substring(0, 30);
                        XLSX.utils.book_append_sheet(wb, wsMissing, safeName + "_缺貨");
                    }
                });

                XLSX.writeFile(wb, "庫存比對_缺漏分析.xlsx");
            };

            const toggleWh = (wh) => {
                if (selectedWarehouses.includes(wh)) setSelectedWarehouses(selectedWarehouses.filter(w => w !== wh));
                else setSelectedWarehouses([...selectedWarehouses, wh]);
            };

            const toggleAllWh = () => {
                if(selectedWarehouses.length === availableWarehouses.length) setSelectedWarehouses([]);
                else setSelectedWarehouses([...availableWarehouses]);
            }

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    {/* Header */}
                    <div className="mb-8 border-b pb-4">
                        <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                            <Icons.Database /> 單檔多倉比對工具 <span className="text-sm bg-red-100 text-red-600 px-2 py-1 rounded ml-2">缺漏分析版</span>
                        </h1>
                        <p className="text-gray-500 mt-2">
                            主檔比對混合倉庫資料。自動產出各倉缺貨清單，以及 <strong className="text-red-500">全部缺貨</strong> 清單。
                        </p>
                    </div>

                    {/* Steps */}
                    <div className="flex items-center gap-4 mb-8 text-sm font-bold text-gray-400">
                        <div className={`flex items-center gap-2 ${step >= 1 ? 'text-blue-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center">1</span> 上傳檔案
                        </div>
                        <div className="w-8 h-px bg-gray-300"></div>
                        <div className={`flex items-center gap-2 ${step >= 2 ? 'text-blue-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center">2</span> 選擇倉庫與欄位
                        </div>
                        <div className="w-8 h-px bg-gray-300"></div>
                        <div className={`flex items-center gap-2 ${step >= 3 ? 'text-blue-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center">3</span> 下載報表
                        </div>
                    </div>

                    {/* Step 1 */}
                    {step === 1 && (
                        <div className="grid md:grid-cols-2 gap-6 animate-fade-in">
                            <Card className="p-6 border-2 border-blue-100 h-full flex flex-col justify-between">
                                <div>
                                    <h3 className="font-bold text-lg text-blue-800 mb-2 flex items-center gap-2"><Icons.FileText/> 主檔案 (Master)</h3>
                                    <p className="text-sm text-gray-500 mb-4">比對基準，完整的料號清單。</p>
                                </div>
                                <div className="bg-blue-50 border-dashed border-2 border-blue-200 rounded-lg p-8 text-center">
                                    {!masterFile ? (
                                        <label className="cursor-pointer block">
                                            <input type="file" accept=".xlsx,.xls,.csv" onChange={handleMasterUpload} />
                                            <div className="mx-auto w-12 h-12 text-blue-400 mb-2"><Icons.Upload /></div>
                                            <div className="text-blue-600 font-medium">點擊上傳主檔</div>
                                        </label>
                                    ) : (
                                        <div className="flex items-center justify-between bg-white p-3 rounded border border-blue-200">
                                            <span className="truncate font-medium text-gray-700">{masterFile.name}</span>
                                            <button onClick={()=>{setMasterFile(null); setMasterData([]);}} className="text-red-400 hover:text-red-600"><Icons.Trash2/></button>
                                        </div>
                                    )}
                                </div>
                            </Card>

                            <Card className="p-6 border-2 border-orange-100 h-full flex flex-col justify-between">
                                <div>
                                    <h3 className="font-bold text-lg text-orange-800 mb-2 flex items-center gap-2"><Icons.Database/> 混合倉庫資料檔 (Source)</h3>
                                    <p className="text-sm text-gray-500 mb-4">包含多個倉庫的庫存資料 (需有欄位區分倉庫)。</p>
                                </div>
                                <div className="bg-orange-50 border-dashed border-2 border-orange-200 rounded-lg p-8 text-center">
                                    {!sourceFile ? (
                                        <label className="cursor-pointer block">
                                            <input type="file" accept=".xlsx,.xls,.csv" onChange={handleSourceUpload} />
                                            <div className="mx-auto w-12 h-12 text-orange-400 mb-2"><Icons.Upload /></div>
                                            <div className="text-orange-600 font-medium">點擊上傳資料檔</div>
                                        </label>
                                    ) : (
                                        <div className="flex items-center justify-between bg-white p-3 rounded border border-orange-200">
                                            <span className="truncate font-medium text-gray-700">{sourceFile.name}</span>
                                            <button onClick={()=>{setSourceFile(null); setSourceData([]);}} className="text-red-400 hover:text-red-600"><Icons.Trash2/></button>
                                        </div>
                                    )}
                                </div>
                            </Card>

                            <div className="md:col-span-2 flex justify-end mt-4">
                                <Button onClick={() => setStep(2)} disabled={!masterFile || !sourceFile}>
                                    下一步 <Icons.ArrowRight />
                                </Button>
                            </div>
                        </div>
                    )}

                    {/* Step 2 */}
                    {step === 2 && (
                        <div className="animate-fade-in space-y-6">
                            {/* Master Config */}
                            <Card className="p-6">
                                <h3 className="font-bold text-blue-800 mb-4 border-b pb-2">1. 主檔設定</h3>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-600 block mb-1">主檔料號 (Key) <span className="text-red-500">*</span></label>
                                        <select className="w-full border p-2 rounded" value={masterKeyCol} onChange={e => setMasterKeyCol(e.target.value)}>
                                            <option value="">請選擇...</option>
                                            {masterHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-gray-600 block mb-1">主檔數值 (排序參考)</label>
                                        <select className="w-full border p-2 rounded" value={masterSortCol} onChange={e => setMasterSortCol(e.target.value)}>
                                            <option value="">(無 - 放在最後)</option>
                                            {masterHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </Card>

                            {/* Source Config */}
                            <Card className="p-6 border-2 border-orange-100">
                                <h3 className="font-bold text-orange-800 mb-4 border-b pb-2">2. 資料檔設定 & 倉庫篩選</h3>
                                <div className="grid md:grid-cols-3 gap-6 mb-6">
                                    <div>
                                        <label className="text-sm font-medium text-gray-600 block mb-1">對應料號 (Key) <span className="text-red-500">*</span></label>
                                        <select className="w-full border p-2 rounded bg-white" value={sourceKeyCol} onChange={e => setSourceKeyCol(e.target.value)}>
                                            <option value="">請選擇...</option>
                                            {sourceHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-gray-600 block mb-1">庫存數值 (Value) <span className="text-red-500">*</span></label>
                                        <select className="w-full border p-2 rounded bg-white" value={sourceValCol} onChange={e => setSourceValCol(e.target.value)}>
                                            <option value="">請選擇...</option>
                                            {sourceHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-bold text-blue-600 block mb-1 flex items-center gap-1"><Icons.Filter /> 倉庫區分欄位 <span className="text-red-500">*</span></label>
                                        <select className="w-full border-2 border-blue-200 p-2 rounded bg-blue-50" value={whCol} onChange={e => setWhCol(e.target.value)}>
                                            <option value="">請選擇 (如: 倉庫代號)...</option>
                                            {sourceHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {whCol && (
                                    <div className="bg-gray-50 p-4 rounded-lg border">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-bold text-gray-700">選擇要比對的倉庫 ({selectedWarehouses.length}/{availableWarehouses.length})</span>
                                            <button onClick={toggleAllWh} className="text-xs text-blue-600 hover:underline">全選/取消全選</button>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-40 overflow-y-auto">
                                            {availableWarehouses.map(wh => (
                                                <label key={wh} className="flex items-center gap-2 cursor-pointer bg-white p-2 rounded border hover:bg-blue-50">
                                                    <input type="checkbox" checked={selectedWarehouses.includes(wh)} onChange={() => toggleWh(wh)} className="w-4 h-4 text-blue-600" />
                                                    <span className="text-sm truncate" title={wh}>{wh}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </Card>

                            <div className="flex justify-between pt-4">
                                <Button variant="secondary" onClick={() => setStep(1)}>上一步</Button>
                                <Button onClick={handleProcess} disabled={!masterKeyCol || !sourceKeyCol || !whCol || selectedWarehouses.length === 0 || isLoading}>
                                    {isLoading ? <div className="animate-spin w-4 h-4"><Icons.RefreshCw/></div> : "開始比對"}
                                </Button>
                            </div>
                        </div>
                    )}

                    {/* Step 3 */}
                    {step === 3 && (
                        <div className="animate-fade-in text-center py-12">
                            <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-6"><Icons.Check /></div>
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">比對完成！</h2>
                            <p className="text-gray-500 mb-8">
                                已針對 <strong>{selectedWarehouses.length}</strong> 個倉庫進行分析。
                            </p>

                            <div className="max-w-4xl mx-auto mb-8 text-left">
                                {/* 全缺貨卡片 */}
                                <div className="mb-4 p-4 rounded-lg border border-red-200 bg-red-50 flex justify-between items-center shadow-sm">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-red-100 rounded-full text-red-600"><Icons.AlertTriangle /></div>
                                        <div>
                                            <h4 className="font-bold text-red-800 text-lg">全部缺貨</h4>
                                            <p className="text-xs text-red-600">所有選定倉庫皆無庫存</p>
                                        </div>
                                    </div>
                                    <div className="text-3xl font-bold text-red-700">{allMissingData.length} <span className="text-sm font-normal text-red-500">筆</span></div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {selectedWarehouses.map(wh => {
                                        const count = missingData[wh] ? missingData[wh].length : 0;
                                        return (
                                            <div key={wh} className={`p-3 rounded border ${count > 0 ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200'}`}>
                                                <div className="text-xs text-gray-500 mb-1">{wh}</div>
                                                <div className={`font-bold text-lg ${count > 0 ? 'text-orange-700' : 'text-green-700'}`}>
                                                    {count > 0 ? `${count} 筆缺漏` : '無缺漏'}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="flex justify-center gap-4">
                                <Button variant="secondary" onClick={() => window.location.reload()}>重新開始</Button>
                                <Button onClick={downloadReport} className="pl-6 pr-6 shadow-lg bg-green-600 hover:bg-green-700">
                                    <Icons.Download /> 下載分析報告 (.xlsx)
                                </Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
