<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 單檔多倉排序與比對工具 (最終修正版)</title>
    
    <!-- 載入函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
        .animate-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="file"] { display: none; }

        .custom-scrollbar {
            scrollbar-width: auto;
            scrollbar-color: #94a3b8 #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; 
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 8px;
            border: 3px solid #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const XLSX = window.XLSX;

        // --- Icons ---
        const Icons = {
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" stroke="none" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:bg-gray-100",
                outline: "border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 text-gray-600"
            };
            return <button onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>{children}</button>;
        };

        function App() {
            const [step, setStep] = useState(1);
            const [file, setFile] = useState(null);
            const [rawData, setRawData] = useState([]);
            const [headers, setHeaders] = useState([]);

            // 欄位設定
            const [colID, setColID] = useState('');
            const [colName, setColName] = useState('');
            const [colWh, setColWh] = useState('');
            const [colQty, setColQty] = useState('');
            const [colCategory, setColCategory] = useState(''); 
            const [colCategoryName, setColCategoryName] = useState(''); 

            // 倉庫選擇與排序
            const [allWarehouses, setAllWarehouses] = useState([]);
            const [selectedWarehouses, setSelectedWarehouses] = useState([]);
            const [mainWarehouse, setMainWarehouse] = useState('');
            const [filterText, setFilterText] = useState('');

            // 大類篩選
            const [allCategories, setAllCategories] = useState([]);
            const [selectedCategories, setSelectedCategories] = useState([]);

            // 結果
            const [finalData, setFinalData] = useState([]);
            const [missingData, setMissingData] = useState({});

            // 讀取檔案
            const handleFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setFile(f);

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsName = wb.SheetNames[0];
                    const ws = wb.Sheets[wsName];
                    const data = XLSX.utils.sheet_to_json(ws);
                    const head = XLSX.utils.sheet_to_json(ws, { header: 1 })[0] || [];
                    setRawData(data);
                    setHeaders(head);

                    // 自動猜測欄位
                    const guessID = head.find(h => h.includes("產品代號") || /ID|Sku|料號/i.test(h));
                    const guessName = head.find(h => h.includes("產品名稱") || /Name|品名/i.test(h));
                    const guessWh = head.find(h => h.includes("分倉代號") || /Wh|Ware|Site|Store|倉庫/i.test(h));
                    const guessQty = head.find(h => h.includes("分倉存量") || /Qty|Stock|數量|庫存/i.test(h));
                    const guessCat = head.find(h => h.includes("大類代號") || /CategoryCode|Type|Class|大類/i.test(h));
                    const guessCatName = head.find(h => h.includes("大類名稱") || /CategoryName|TypeName|大類名/i.test(h));

                    if (guessID) setColID(guessID);
                    if (guessName) setColName(guessName);
                    if (guessWh) setColWh(guessWh);
                    if (guessQty) setColQty(guessQty);
                    if (guessCat) setColCategory(guessCat);
                    if (guessCatName) setColCategoryName(guessCatName);
                };
                reader.readAsBinaryString(f);
            };

            const scanData = () => {
                const uniqueWh = [...new Set(rawData.map(r => r[colWh]).filter(w => w))].sort();
                setAllWarehouses(uniqueWh);
                setSelectedWarehouses([]);
                setFilterText('');

                const uniqueCats = [...new Set(rawData.map(r => r[colCategory]).filter(c => c))].sort();
                setAllCategories(uniqueCats);

                const defaultCats = uniqueCats.filter(c => {
                    const s = String(c).toUpperCase().trim();
                    if (['C1','C2','C3','C4','C5'].includes(s)) return true;
                    if (['G3','G4'].includes(s)) return true;
                    if (['X3','X4','X5','X6'].includes(s)) return true;
                    if (s === 'XZ') return true;
                    return false;
                });
                setSelectedCategories(defaultCats);

                setStep(2);
            };

            const addToSelected = (wh) => {
                setAllWarehouses(prev => prev.filter(x => x !== wh));
                setSelectedWarehouses(prev => [...prev, wh]);
            };

            const removeFromSelected = (wh) => {
                setSelectedWarehouses(prev => prev.filter(x => x !== wh));
                setAllWarehouses(prev => [...prev, wh].sort());
                if (mainWarehouse === wh) setMainWarehouse('');
            };

            const moveUp = (index) => {
                if (index === 0) return;
                const newArr = [...selectedWarehouses];
                [newArr[index - 1], newArr[index]] = [newArr[index], newArr[index - 1]];
                setSelectedWarehouses(newArr);
            };

            const moveDown = (index) => {
                if (index === selectedWarehouses.length - 1) return;
                const newArr = [...selectedWarehouses];
                [newArr[index + 1], newArr[index]] = [newArr[index], newArr[index + 1]];
                setSelectedWarehouses(newArr);
            };

            const toggleCategory = (cat) => {
                if (selectedCategories.includes(cat)) {
                    setSelectedCategories(prev => prev.filter(c => c !== cat));
                } else {
                    setSelectedCategories(prev => [...prev, cat]);
                }
            };

            const processData = () => {
                const productMap = new Map(); 
                const mainWhProductIDs = new Set(); 

                const filteredData = rawData.filter(row => {
                    const cat = row[colCategory];
                    const wh = row[colWh];
                    return selectedCategories.includes(cat) && selectedWarehouses.includes(wh);
                });

                filteredData.forEach(row => {
                    const id = row[colID];
                    const wh = row[colWh];
                    const qty = row[colQty];
                    
                    if (!id || !wh) return;

                    if (wh === mainWarehouse) {
                        mainWhProductIDs.add(id);
                    }

                    if (!productMap.has(id)) {
                        productMap.set(id, {
                            id: id,
                            name: row[colName] || '',
                            // 不在總表輸出大類代號，但為了邏輯正確還是可以暫存，或直接不存
                            // 這裡存著以防萬一，但輸出時不放
                            categoryName: colCategoryName ? (row[colCategoryName] || '') : '',
                            qtys: {}
                        });
                    }

                    const pInfo = productMap.get(id);
                    
                    if (wh === mainWarehouse) {
                        if(row[colName]) pInfo.name = row[colName];
                        if(colCategoryName && row[colCategoryName]) pInfo.categoryName = row[colCategoryName];
                    } else {
                        if(!pInfo.name && row[colName]) pInfo.name = row[colName];
                        if(!pInfo.categoryName && colCategoryName && row[colCategoryName]) pInfo.categoryName = row[colCategoryName];
                    }
                    
                    pInfo.qtys[wh] = qty;
                });

                // 1. 產生總表 (移除大類代號)
                const summaryRows = [];
                const sortedIDs = Array.from(productMap.keys()).sort();

                sortedIDs.forEach(id => {
                    const info = productMap.get(id);
                    const rowObj = {
                        '大類名稱': info.categoryName,
                        '產品代號': id,
                        '產品名稱': info.name,
                        // '大類代號': info.categoryCode // 已移除
                    };
                    selectedWarehouses.forEach(wh => {
                        // 空白不帶入 0
                        rowObj[wh] = info.qtys[wh] !== undefined ? info.qtys[wh] : "";
                    });
                    summaryRows.push(rowObj);
                });

                // 2. 產生缺漏表 (邏輯：主倉有，但目標分倉沒有)
                const missingReport = {};

                selectedWarehouses.forEach(targetWh => {
                    if (targetWh === mainWarehouse) return; 

                    const missingItems = [];
                    
                    mainWhProductIDs.forEach(itemID => {
                        const info = productMap.get(itemID);
                        const targetQty = info.qtys[targetWh];

                        if (targetQty === undefined) {
                            missingItems.push({
                                '產品代號': itemID,
                                '產品名稱': info.name,
                                '大類名稱': info.categoryName,
                                '主倉庫存': info.qtys[mainWarehouse] // 顯示主倉現有庫存
                            });
                        }
                    });

                    if (missingItems.length > 0) {
                        missingReport[targetWh] = missingItems;
                    }
                });

                setFinalData(summaryRows);
                setMissingData(missingReport);
                setStep(3);
            };

            const downloadExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // 1. 總表 (大類名稱在第一欄，無大類代號)
                const headerOrder = ['大類名稱', '產品代號', '產品名稱', ...selectedWarehouses];
                const wsSummary = XLSX.utils.json_to_sheet(finalData, { header: headerOrder });
                XLSX.utils.book_append_sheet(wb, wsSummary, "庫存總表");

                // 2. 缺漏 Sheets
                Object.keys(missingData).forEach(wh => {
                    const sheetName = `${wh}_缺貨`;
                    const safeName = sheetName.substring(0, 30).replace(/[\\/?*[\]]/g, '');
                    const ws = XLSX.utils.json_to_sheet(missingData[wh]); 
                    XLSX.utils.book_append_sheet(wb, ws, safeName);
                });

                // 3. 原始資料備份
                const wsRaw = XLSX.utils.json_to_sheet(rawData);
                XLSX.utils.book_append_sheet(wb, wsRaw, "原始資料備份");

                XLSX.writeFile(wb, "庫存排序比對結果.xlsx");
            };

            const filteredWarehouses = allWarehouses.filter(wh => 
                String(wh).toLowerCase().includes(filterText.toLowerCase())
            );

            return (
                <div className="min-h-screen p-8 max-w-6xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <Icons.Database /> 單檔多倉排序與比對工具
                    </h1>
                    <p className="text-gray-500 mb-8">支援大類篩選、倉庫排序、補貨分析，報表不含大類代號。</p>

                    {/* Step 1 */}
                    {step === 1 && (
                        <div className="animate-fade-in space-y-6">
                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-4">1. 上傳與欄位對應</h3>
                                <div className="grid md:grid-cols-2 gap-8">
                                    <label className="border-2 border-dashed border-blue-300 bg-blue-50 rounded-lg h-full flex flex-col items-center justify-center cursor-pointer hover:bg-blue-100 transition min-h-[200px]">
                                        <input type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} />
                                        <div className="text-blue-500 mb-2"><Icons.Upload /></div>
                                        <span className="font-medium text-blue-700">{file ? file.name : "點擊上傳 Excel 檔案"}</span>
                                    </label>

                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-sm font-bold text-gray-600 block mb-1">產品代號 (預設: 產品代號)</label>
                                                <select className="w-full border p-2 rounded" value={colID} onChange={e=>setColID(e.target.value)}>
                                                    <option value="">請選擇...</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold text-gray-600 block mb-1">產品名稱 (預設: 產品名稱)</label>
                                                <select className="w-full border p-2 rounded" value={colName} onChange={e=>setColName(e.target.value)}>
                                                    <option value="">請選擇...</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold text-blue-600 block mb-1">倉庫代號 (預設: 分倉代號)</label>
                                                <select className="w-full border border-blue-300 p-2 rounded" value={colWh} onChange={e=>setColWh(e.target.value)}>
                                                    <option value="">請選擇...</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold text-gray-600 block mb-1">庫存數量 (預設: 分倉存量)</label>
                                                <select className="w-full border p-2 rounded" value={colQty} onChange={e=>setColQty(e.target.value)}>
                                                    <option value="">請選擇...</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="pt-2 border-t mt-2 grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-sm font-bold text-purple-600 block mb-1 flex items-center gap-1">
                                                    <Icons.Filter /> 大類代號 (預設: 大類代號)
                                                </label>
                                                <select className="w-full border border-purple-200 bg-purple-50 p-2 rounded" value={colCategory} onChange={e=>setColCategory(e.target.value)}>
                                                    <option value="">請選擇...</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold text-gray-600 block mb-1 flex items-center gap-1">
                                                    大類名稱 (選填)
                                                </label>
                                                <select className="w-full border border-gray-300 bg-gray-50 p-2 rounded" value={colCategoryName} onChange={e=>setColCategoryName(e.target.value)}>
                                                    <option value="">(無)</option>
                                                    {headers.map(h => <option key={h} value={h}>{h}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end">
                                    <Button onClick={scanData} disabled={!file || !colID || !colWh || !colQty || !colCategory}>
                                        下一步: 篩選與排序 <Icons.ArrowRight />
                                    </Button>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* Step 2 */}
                    {step === 2 && (
                        <div className="animate-fade-in space-y-6">
                            
                            <Card className="p-4 bg-purple-50 border border-purple-100">
                                <h3 className="font-bold text-lg mb-2 text-purple-800 flex items-center gap-2">
                                    <Icons.Filter /> 大類篩選
                                </h3>
                                <div className="text-sm text-gray-600 mb-3">只有勾選的大類代號會出現在報表中。</div>
                                <div className="max-h-32 overflow-y-auto custom-scrollbar bg-white p-3 rounded border border-purple-200 grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                                    {allCategories.map(cat => (
                                        <label key={cat} className="flex items-center gap-1 cursor-pointer hover:bg-purple-50 p-1 rounded">
                                            <input 
                                                type="checkbox" 
                                                checked={selectedCategories.includes(cat)} 
                                                onChange={() => toggleCategory(cat)}
                                                className="w-4 h-4 text-purple-600 rounded" 
                                            />
                                            <span className="text-sm font-mono">{cat}</span>
                                        </label>
                                    ))}
                                </div>
                                <div className="mt-2 text-xs text-gray-500 text-right">
                                    已選 {selectedCategories.length} / {allCategories.length} 個大類
                                </div>
                            </Card>

                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-2">倉庫選擇與排序</h3>
                                <p className="text-sm text-gray-500 mb-4">左側加入，右側排序，並指定主要倉庫。</p>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="border rounded-lg p-3 bg-gray-50 flex flex-col shadow-inner">
                                        <div className="flex justify-between items-center mb-2 flex-shrink-0">
                                            <div className="font-bold text-gray-500 text-sm">可用倉庫 ({allWarehouses.length})</div>
                                            <div className="relative">
                                                <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-gray-400">
                                                    <Icons.Search />
                                                </div>
                                                <input 
                                                    type="text" 
                                                    placeholder="搜尋..." 
                                                    className="pl-8 pr-2 py-1 border rounded text-sm w-32 focus:w-48 transition-all outline-none focus:ring-2 focus:ring-blue-300"
                                                    value={filterText}
                                                    onChange={e => setFilterText(e.target.value)}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="h-[400px] overflow-y-auto space-y-1 bg-white border rounded p-2 custom-scrollbar">
                                            {filteredWarehouses.length === 0 && (
                                                <div className="text-center text-gray-400 py-4 text-sm">無符合倉庫</div>
                                            )}
                                            {filteredWarehouses.map(wh => (
                                                <div key={wh} onClick={() => addToSelected(wh)} 
                                                     className="p-2 border-b last:border-0 hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors">
                                                    <span className="text-gray-700">{wh}</span>
                                                    <span className="text-blue-500 font-bold opacity-0 group-hover:opacity-100">+</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="border-2 border-blue-200 rounded-lg p-3 bg-white flex flex-col shadow-sm">
                                        <div className="font-bold text-blue-700 mb-2 text-sm bg-blue-50 p-2 rounded flex-shrink-0">已選倉庫 (拖動排序) - {selectedWarehouses.length} 個</div>
                                        
                                        <div className="h-[400px] overflow-y-auto space-y-2 custom-scrollbar p-1">
                                            {selectedWarehouses.length === 0 && <div className="text-gray-400 text-center mt-20">請從左側點擊加入倉庫</div>}
                                            {selectedWarehouses.map((wh, idx) => (
                                                <div key={wh} className="flex items-center gap-2 p-2 border rounded bg-white hover:shadow-md transition-shadow border-gray-100">
                                                    <div className="flex flex-col gap-1">
                                                        <button onClick={() => moveUp(idx)} className="text-gray-300 hover:text-blue-600 disabled:opacity-10" disabled={idx===0}><Icons.ArrowUp /></button>
                                                        <button onClick={() => moveDown(idx)} className="text-gray-300 hover:text-blue-600 disabled:opacity-10" disabled={idx===selectedWarehouses.length-1}><Icons.ArrowDown /></button>
                                                    </div>
                                                    <div className="flex-1 font-medium text-gray-800">{wh}</div>
                                                    
                                                    <label className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded transition-colors ${mainWarehouse === wh ? 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-400' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}>
                                                        <input type="radio" name="mainWh" checked={mainWarehouse === wh} onChange={() => setMainWarehouse(wh)} className="hidden" />
                                                        <span className="text-xs font-bold">
                                                            {mainWarehouse === wh ? '主要' : '設為主倉'}
                                                        </span>
                                                        {mainWarehouse === wh && <span className="text-yellow-500"><Icons.Star /></span>}
                                                    </label>

                                                    <button onClick={() => removeFromSelected(wh)} className="text-gray-300 hover:text-red-500 p-1"><Icons.Trash /></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 flex justify-between">
                                    <Button variant="outline" onClick={() => setStep(1)}><Icons.ArrowLeft /> 上一步</Button>
                                    <Button onClick={processData} disabled={selectedWarehouses.length === 0 || !mainWarehouse || selectedCategories.length === 0}>
                                        產生報表 <Icons.Check />
                                    </Button>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* Step 3: Download */}
                    {step === 3 && (
                        <div className="animate-fade-in text-center py-12">
                            <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-6">
                                <Icons.Check />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">分析完成！</h2>
                            <p className="text-gray-600 mb-8">
                                總表包含：<strong>大類名稱 (首欄)</strong>、產品代號、產品名稱，以及 {selectedWarehouses.join(', ')} 的庫存。<br/>
                                <strong>空白欄位表示該倉庫無此產品紀錄。</strong>
                            </p>
                            
                            {/* Summary Cards */}
                            <div className="flex flex-wrap justify-center gap-4 mb-8">
                                <div className="bg-white p-4 rounded shadow border border-gray-200 w-48">
                                    <div className="text-xs text-gray-500">符合篩選產品數</div>
                                    <div className="text-2xl font-bold text-blue-600">{finalData.length}</div>
                                </div>
                                {Object.keys(missingData).map(wh => (
                                    <div key={wh} className="bg-white p-4 rounded shadow border border-red-100 w-48">
                                        <div className="text-xs text-gray-500">{wh} 缺於主倉</div>
                                        <div className="text-2xl font-bold text-red-500">{missingData[wh].length} <span className="text-sm">筆</span></div>
                                    </div>
                                ))}
                            </div>

                            <div className="flex justify-center gap-4">
                                <Button variant="outline" onClick={() => window.location.reload()}><Icons.Refresh /> 重新開始</Button>
                                <Button onClick={downloadExcel} className="shadow-lg"><Icons.Download /> 下載 Excel 報表</Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
