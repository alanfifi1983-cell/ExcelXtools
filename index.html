<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 多檔庫存合併工具 (免安裝版)</title>
    
    <!-- 1. 載入必要的函式庫 (React, Tailwind, SheetJS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- 簡單的樣式設定 -->
    <style>
        body { background-color: #f9fafb; font-family: "Microsoft JhengHei", sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* 隱藏原生 file input */
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 2. React 程式邏輯區 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 圖示元件 ---
        const Icons = {
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            FileSpreadsheet: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><path d="M14 2v6h6"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/><path d="M5 13v-3h18v3"/><path d="M5 17v-3h18v3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            ArrowLeftRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 11 21 7 17 3"></polyline><line x1="21" y1="7" x2="9" y2="7"></line><polyline points="7 21 3 17 7 13"></polyline><line x1="3" y1="17" x2="15" y2="17"></line></svg>,
            Type: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
            Map: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        };

        const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:bg-gray-100",
                outline: "border-2 border-gray-200 text-gray-600 hover:border-blue-500 hover:text-blue-500",
                danger: "bg-red-50 text-red-600 hover:bg-red-100"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        // --- 主程式元件 ---
        function ExcelMerger() {
            const [step, setStep] = useState(1);
            const [isLoading, setIsLoading] = useState(false);
            
            // 1. 檔案 State
            const [masterFile, setMasterFile] = useState(null);
            const [sourceFile, setSourceFile] = useState(null); // 改為單一來源檔
            
            // 2. 主檔解析資料
            const [masterWorkbook, setMasterWorkbook] = useState(null);
            const [masterSheetName, setMasterSheetName] = useState('');
            const [masterHeaders, setMasterHeaders] = useState([]);
            const [masterData, setMasterData] = useState([]);
            const [masterKeyCol, setMasterKeyCol] = useState('');
            const [masterValCol, setMasterValCol] = useState(''); 

            // 3. 來源檔解析與設定
            const [sourceConfig, setSourceConfig] = useState(null);
            const [warehouseOptions, setWarehouseOptions] = useState([]); // 分析出的所有倉庫代號
            const [selectedWarehouses, setSelectedWarehouses] = useState([]); // 使用者勾選的倉庫代號

            // 4. 結果
            const [mergedData, setMergedData] = useState([]);
            const [orphanData, setOrphanData] = useState([]); 
            const [finalHeaderOrder, setFinalHeaderOrder] = useState([]); 

            const readFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        resolve({ file, workbook });
                    };
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            };

            const handleMasterUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setMasterFile(file);
                const { workbook } = await readFile(file);
                setMasterWorkbook(workbook);
                setMasterSheetName(workbook.SheetNames[0]);
            };

            const handleSourceUpload = (e) => {
                const file = e.target.files[0];
                if(file) setSourceFile(file);
            };

            useEffect(() => {
                if (masterWorkbook && masterSheetName) {
                    const ws = masterWorkbook.Sheets[masterSheetName];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (json.length > 0) {
                        const headers = json[0];
                        setMasterHeaders(headers);
                        setMasterData(XLSX.utils.sheet_to_json(ws));
                        const potentialKey = headers.find(h => /id|sku|part|no|料號|編號/i.test(h));
                        if (potentialKey) setMasterKeyCol(potentialKey);
                        const potentialVal = headers.find(h => /qty|stock|count|amount|數量|庫存/i.test(h));
                        if (potentialVal) setMasterValCol(potentialVal);
                    }
                }
            }, [masterWorkbook, masterSheetName]);

            // 初始化設定 (從 Step 1 -> Step 2)
            const initConfigs = async () => {
                setIsLoading(true);
                try {
                    // 讀取來源檔
                    const { workbook } = await readFile(sourceFile);
                    const firstSheet = workbook.SheetNames[0];
                    const ws = workbook.Sheets[firstSheet];
                    const rawData = XLSX.utils.sheet_to_json(ws);
                    const headers = XLSX.utils.sheet_to_json(ws, { header: 1 })[0] || [];
                    
                    // 猜測欄位
                    const guessKey = headers.find(h => /id|sku|part|no|料號|編號/i.test(h)) || '';
                    const guessVal = headers.find(h => /qty|stock|count|amount|數量|庫存/i.test(h)) || '';
                    const guessGroup = headers.find(h => /warehouse|store|site|loc|dep|倉|店|代號/i.test(h)) || '';

                    setSourceConfig({
                        fileName: sourceFile.name,
                        headers: headers,
                        data: rawData,
                        keyCol: guessKey,
                        valCol: guessVal,
                        groupCol: guessGroup
                    });
                    
                    // 若有猜到分組欄位，嘗試先分析一次
                    if (guessGroup) {
                        analyzeWarehouses(rawData, guessGroup);
                    } else {
                        setWarehouseOptions([]);
                        setSelectedWarehouses([]);
                    }

                    setStep(2);
                } catch (e) {
                    console.error(e);
                    alert("讀取檔案錯誤");
                } finally {
                    setIsLoading(false);
                }
            };

            // 分析來源檔中的倉庫代號
            const analyzeWarehouses = (data, groupCol) => {
                if (!groupCol) return;
                const uniqueWH = new Set();
                data.forEach(row => {
                    if (row[groupCol]) uniqueWH.add(String(row[groupCol]).trim());
                });
                const sortedWH = Array.from(uniqueWH).sort();
                setWarehouseOptions(sortedWH);
                setSelectedWarehouses([]); // 預設全不選
            };

            // 當使用者修改來源檔的設定
            const updateSourceConfig = (field, value) => {
                const newConfig = { ...sourceConfig, [field]: value };
                setSourceConfig(newConfig);
                if (field === 'groupCol') {
                    analyzeWarehouses(newConfig.data, value);
                }
            };

            const toggleWarehouse = (wh) => {
                if (selectedWarehouses.includes(wh)) {
                    setSelectedWarehouses(prev => prev.filter(w => w !== wh));
                } else {
                    setSelectedWarehouses(prev => [...prev, wh]);
                }
            };
            
            const toggleAllWarehouses = () => {
                if (selectedWarehouses.length === warehouseOptions.length) {
                    setSelectedWarehouses([]);
                } else {
                    setSelectedWarehouses([...warehouseOptions]);
                }
            };

            // 執行合併 (Step 2 -> Step 3)
            const handleProcess = async () => {
                setIsLoading(true);
                setTimeout(() => {
                    try {
                        const resultRows = JSON.parse(JSON.stringify(masterData));
                        
                        // 建立 Master Map 以便快速查找
                        const masterMap = new Map();
                        resultRows.forEach(row => {
                            const key = row[masterKeyCol] !== undefined ? String(row[masterKeyCol]).trim() : "UNDEFINED";
                            if (key !== "UNDEFINED") masterMap.set(key, row);
                        });

                        const orphans = [];
                        const { keyCol, valCol, groupCol, data } = sourceConfig;

                        // 遍歷所有選擇的倉庫代號，作為新的欄位名稱
                        selectedWarehouses.forEach(whCode => {
                            // 篩選出屬於該倉庫的資料
                            const warehouseRows = data.filter(row => String(row[groupCol]).trim() === whCode);
                            
                            warehouseRows.forEach(row => {
                                const rowKey = row[keyCol] !== undefined ? String(row[keyCol]).trim() : null;
                                const rowVal = row[valCol];
                                
                                if (rowKey) {
                                    if (masterMap.has(rowKey)) {
                                        const masterRow = masterMap.get(rowKey);
                                        // 直接使用倉庫代號作為欄位名稱
                                        masterRow[whCode] = rowVal; 
                                    } else {
                                        // 記錄 Orphan，並標記來源倉庫
                                        orphans.push({ warehouse: whCode, data: row });
                                    }
                                }
                            });
                        });

                        // 決定最後欄位順序
                        const newComparisonCols = selectedWarehouses;
                        let newHeaderOrder = [];
                        if (masterValCol && masterHeaders.includes(masterValCol)) {
                            const insertIndex = masterHeaders.indexOf(masterValCol) + 1;
                            newHeaderOrder = [...masterHeaders.slice(0, insertIndex), ...newComparisonCols, ...masterHeaders.slice(insertIndex)];
                        } else {
                            newHeaderOrder = [...masterHeaders, ...newComparisonCols];
                        }

                        setFinalHeaderOrder(newHeaderOrder);
                        setMergedData(resultRows);
                        setOrphanData(orphans);
                        setStep(3);
                    } catch (error) {
                        console.error(error);
                        alert("處理錯誤: " + error.message);
                    } finally {
                        setIsLoading(false);
                    }
                }, 100);
            };

            const sanitizeSheetName = (name) => name.replace(/[*?\/\[\]\\]/g, '').substring(0, 30);

            const downloadReport = () => {
                const wb = XLSX.utils.book_new();
                
                // 1. 總表
                const wsMerged = XLSX.utils.json_to_sheet(mergedData, { header: finalHeaderOrder });
                XLSX.utils.book_append_sheet(wb, wsMerged, "庫存合併總表");

                // 2. 額外資料 (Orphans) - 依倉庫分頁
                selectedWarehouses.forEach(whCode => {
                    const fileOrphans = orphanData.filter(o => o.warehouse === whCode).map(o => o.data);
                    if (fileOrphans.length > 0) {
                        const sheetName = sanitizeSheetName(`額外_${whCode}`);
                        const ws = XLSX.utils.json_to_sheet(fileOrphans, { header: sourceConfig.headers });
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    }
                });
                XLSX.writeFile(wb, "Inventory_Merge_Result.xlsx");
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-8 border-b pb-4">
                            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                <Icons.Database /> Excel 多檔庫存合併工具 (單檔多倉版)
                            </h1>
                            <p className="text-gray-500 mt-2">請上傳含有「倉庫代號」欄位的單一來源檔案進行比對。</p>
                        </header>

                        {/* 進度條 */}
                        <div className="flex items-center mb-8">
                            {[1, 2, 3].map(s => (
                                <React.Fragment key={s}>
                                    <div className={`flex items-center gap-2 ${step >= s ? 'text-blue-600 font-bold' : 'text-gray-400'}`}>
                                        <span className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${step >= s ? 'border-blue-600 bg-blue-50' : 'border-gray-300'}`}>{s}</span>
                                        <span className="hidden sm:inline">{s === 1 ? "上傳檔案" : s === 2 ? "欄位與倉庫設定" : "下載結果"}</span>
                                    </div>
                                    {s < 3 && <div className="flex-1 h-px bg-gray-300 mx-4"></div>}
                                </React.Fragment>
                            ))}
                        </div>

                        {/* Step 1: Upload */}
                        {step === 1 && (
                            <div className="grid md:grid-cols-12 gap-6 animate-fade-in">
                                <Card className="md:col-span-5 p-6 border-2 border-blue-100 h-full flex flex-col">
                                    <h3 className="text-lg font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.FileText /> 1. 主檔案 (Master)</h3>
                                    <div className="bg-blue-50 border border-blue-200 border-dashed rounded-lg p-6 text-center flex-1 flex flex-col justify-center items-center">
                                        {!masterFile ? (
                                            <>
                                                <input type="file" id="masterUpload" accept=".xlsx,.xls,.csv" onChange={handleMasterUpload} />
                                                <label htmlFor="masterUpload" className="cursor-pointer flex flex-col items-center">
                                                    <div className="w-10 h-10 text-blue-400 mb-2"><Icons.Upload /></div>
                                                    <span className="text-blue-700 font-medium">上傳主檔</span>
                                                </label>
                                            </>
                                        ) : (
                                            <div className="w-full">
                                                <div className="flex items-center justify-between bg-white p-3 rounded shadow-sm border border-blue-100">
                                                    <div className="flex items-center gap-2 truncate">
                                                        <div className="w-5 h-5 text-green-600"><Icons.FileSpreadsheet /></div>
                                                        <span className="font-medium text-gray-700 truncate">{masterFile.name}</span>
                                                    </div>
                                                    <button onClick={() => { setMasterFile(null); setMasterWorkbook(null); }} className="text-red-400 hover:text-red-600"><Icons.Trash2 /></button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </Card>
                                <Card className="md:col-span-7 p-6 border-2 border-orange-100 h-full flex flex-col">
                                    <h3 className="text-lg font-bold text-orange-800 mb-2 flex items-center gap-2"><Icons.Database /> 2. 來源檔案 (含多倉資料)</h3>
                                    <div className="bg-orange-50 border border-orange-200 border-dashed rounded-lg p-6 text-center flex-1 flex flex-col justify-center items-center">
                                        {!sourceFile ? (
                                            <>
                                                <input type="file" id="sourceUpload" accept=".xlsx,.xls,.csv" onChange={handleSourceUpload} />
                                                <label htmlFor="sourceUpload" className="cursor-pointer flex flex-col items-center">
                                                    <div className="w-10 h-10 text-orange-400 mb-2"><Icons.Upload /></div>
                                                    <span className="text-orange-700 font-medium">上傳來源檔 (含倉庫代號欄位)</span>
                                                </label>
                                            </>
                                        ) : (
                                            <div className="w-full">
                                                <div className="flex items-center justify-between bg-white p-3 rounded shadow-sm border border-orange-100">
                                                    <div className="flex items-center gap-2 truncate">
                                                        <div className="w-5 h-5 text-green-600"><Icons.FileSpreadsheet /></div>
                                                        <span className="font-medium text-gray-700 truncate">{sourceFile.name}</span>
                                                    </div>
                                                    <button onClick={() => setSourceFile(null)} className="text-red-400 hover:text-red-600"><Icons.Trash2 /></button>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-2 text-left">請確保此檔案中包含一個區分「倉庫代號」或「店別」的欄位。</p>
                                            </div>
                                        )}
                                    </div>
                                </Card>
                            </div>
                        )}

                        {/* Step 2: Config */}
                        {step === 2 && sourceConfig && (
                            <div className="animate-fade-in space-y-8">
                                <Card className="p-6 border-l-4 border-l-blue-500">
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="w-full md:w-1/3">
                                            <h3 className="text-lg font-bold text-gray-800 mb-2">1. 主檔設定</h3>
                                            <p className="text-sm text-gray-500">設定 Key 值與主要數值欄位，<span className="text-blue-600 font-bold">合併的倉庫欄位將插入在數值欄位之後。</span></p>
                                        </div>
                                        <div className="w-full md:w-2/3 grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">主檔「料號」 (Key) <span className="text-red-500">*</span></label>
                                                <select className="w-full border-2 border-blue-200 rounded p-2 bg-white" value={masterKeyCol} onChange={(e) => setMasterKeyCol(e.target.value)}><option value="">請選擇...</option>{masterHeaders.map(h => <option key={h} value={h}>{h}</option>)}</select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">主檔「庫存/數值」 (排序依據)</label>
                                                <div className="relative">
                                                    <select className="w-full border-2 border-green-100 rounded p-2 bg-green-50 pr-8" value={masterValCol} onChange={(e) => setMasterValCol(e.target.value)}><option value="">(無 - 放在最後面)</option>{masterHeaders.map(h => <option key={h} value={h}>{h}</option>)}</select>
                                                    <div className="absolute right-2 top-2.5 w-4 h-4 text-green-600 pointer-events-none"><Icons.ArrowLeftRight /></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </Card>
                                <Card className="p-6 border-l-4 border-l-orange-500">
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="w-full md:w-1/3">
                                            <h3 className="text-lg font-bold text-gray-800 mb-2">2. 來源檔欄位設定</h3>
                                            <p className="text-sm text-gray-500">請指定來源檔中的對應欄位，尤其是<span className="text-orange-600 font-bold">分組欄位 (倉庫代號)</span>。</p>
                                        </div>
                                        <div className="w-full md:w-2/3 grid md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">來源 Key (料號) <span className="text-red-500">*</span></label>
                                                <select className="w-full border border-gray-300 rounded p-2 bg-gray-50" value={sourceConfig.keyCol} onChange={(e) => updateSourceConfig('keyCol', e.target.value)}><option value="">請選擇...</option>{sourceConfig.headers.map(h => <option key={h} value={h}>{h}</option>)}</select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">來源 Value (庫存) <span className="text-red-500">*</span></label>
                                                <select className="w-full border-2 border-green-100 rounded p-2 bg-green-50" value={sourceConfig.valCol} onChange={(e) => updateSourceConfig('valCol', e.target.value)}><option value="">請選擇...</option>{sourceConfig.headers.map(h => <option key={h} value={h}>{h}</option>)}</select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">分組欄位 (倉庫代號) <span className="text-red-500">*</span></label>
                                                <select className="w-full border-2 border-orange-200 rounded p-2 bg-orange-50 font-bold text-orange-800" value={sourceConfig.groupCol} onChange={(e) => updateSourceConfig('groupCol', e.target.value)}><option value="">請選擇...</option>{sourceConfig.headers.map(h => <option key={h} value={h}>{h}</option>)}</select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* 倉庫選擇區 */}
                                    {sourceConfig.groupCol && (
                                        <div className="mt-8 pt-6 border-t border-gray-100">
                                            <div className="flex items-center justify-between mb-4">
                                                <h4 className="text-base font-bold text-gray-700 flex items-center gap-2"><Icons.Map /> 請選擇要匯出的倉庫 ({selectedWarehouses.length}/{warehouseOptions.length})</h4>
                                                <button onClick={toggleAllWarehouses} className="text-sm text-blue-600 hover:text-blue-800 underline">
                                                    {selectedWarehouses.length === warehouseOptions.length ? "取消全選" : "全選"}
                                                </button>
                                            </div>
                                            
                                            {warehouseOptions.length > 0 ? (
                                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-[300px] overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200">
                                                    {warehouseOptions.map(wh => (
                                                        <label key={wh} className={`flex items-center gap-2 p-2 rounded cursor-pointer border transition-all ${selectedWarehouses.includes(wh) ? 'bg-blue-50 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-100'}`}>
                                                            <input type="checkbox" checked={selectedWarehouses.includes(wh)} onChange={() => toggleWarehouse(wh)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                                            <span className="text-sm truncate font-medium" title={wh}>{wh}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-400 bg-gray-50 rounded-lg border border-gray-200 border-dashed">
                                                    在此欄位中找不到任何資料，請確認是否選對欄位。
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </Card>

                                <div className="flex justify-between pt-4">
                                    <Button variant="secondary" onClick={() => setStep(1)}>上一步</Button>
                                    <Button onClick={handleProcess} disabled={!masterKeyCol || !sourceConfig.keyCol || !sourceConfig.valCol || !sourceConfig.groupCol || selectedWarehouses.length === 0 || isLoading} className="w-48">{isLoading ? <div className="w-4 h-4 animate-spin"><Icons.RefreshCw /></div> : "開始合併"}</Button>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Result */}
                        {step === 3 && (
                            <div className="animate-fade-in text-center py-12">
                                <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-600 rounded-full mb-6 shadow-sm"><div className="w-10 h-10"><Icons.Check /></div></div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-2">合併完成！</h2>
                                <p className="text-gray-600 mb-8 max-w-lg mx-auto">已將 <strong>{selectedWarehouses.length}</strong> 個倉庫的庫存資料合併至主表。<br/>發現 <strong>{orphanData.length}</strong> 筆額外料號。</p>
                                <div className="flex justify-center gap-4 mb-12">
                                    <Button variant="secondary" onClick={() => window.location.reload()}>重新開始</Button>
                                    <Button onClick={downloadReport} className="pl-8 pr-8 py-3 text-lg shadow-lg bg-green-600 hover:bg-green-700"><div className="w-5 h-5"><Icons.Download /></div> 下載報表 (.xlsx)</Button>
                                </div>
                                <div className="mt-8 text-left max-w-5xl mx-auto bg-white border rounded-xl overflow-hidden shadow-lg">
                                    <div className="bg-gray-50 p-4 border-b flex justify-between items-center"><span className="font-bold text-gray-700">預覽 (前 5 筆)</span></div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50 text-gray-600 font-semibold border-b">
                                                <tr>{finalHeaderOrder.slice(0, 10).map((h, idx) => (<th key={idx} className={`p-3 text-left border-r min-w-[100px] ${h === masterKeyCol ? 'bg-gray-100 font-bold' : ''} ${h === masterValCol ? 'bg-green-50 text-green-800 border-green-200' : ''} ${selectedWarehouses.includes(h) ? 'bg-blue-50 text-blue-800' : ''}`}>{h}</th>))}</tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {mergedData.slice(0, 5).map((row, i) => (<tr key={i} className="hover:bg-gray-50 transition-colors">{finalHeaderOrder.slice(0, 10).map((h, idx) => (<td key={idx} className={`p-3 border-r ${h === masterValCol ? 'bg-green-50/30 font-medium' : ''} ${selectedWarehouses.includes(h) ? 'bg-blue-50/30 font-bold' : ''}`}>{row[h] !== undefined ? row[h] : '-'}</td>))}</tr>))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 1 && (
                             <div className="mt-8 flex justify-end">
                                <Button onClick={initConfigs} disabled={!masterFile || !sourceFile || isLoading} className="pl-8 pr-8">{isLoading ? <div className="w-4 h-4 animate-spin"><Icons.RefreshCw /></div> : "下一步：設定"} {!isLoading && <div className="w-4 h-4"><Icons.ArrowRight /></div>}</Button>
                             </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExcelMerger />);
    </script>
</body>
</html>
